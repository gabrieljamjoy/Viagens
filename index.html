<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ViagensPro DEV - Gerenciador de Rotas M√∫ltiplas (Online)</title>
    <style>
        /* BASE & TYPOGRAPHY */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f6f9;
            color: #333;
        }

        /* HEADER - DESTAQUE PARA VERS√ÉO DEV */
        .app-header {
            background-color: #ff5722; /* Cor de destaque DEV */
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .app-header h1 {
            margin: 0;
            font-size: 1.5em;
            font-weight: 700;
        }

        /* CONTAINER */
        .container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* CARDS (SECTIONS) */
        .card {
            background-color: white;
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            border-top: 5px solid #ff5722; /* Linha de destaque DEV */
        }
        .card h2 {
            color: #ff5722; /* Cor de destaque DEV */
            margin-top: 0;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        /* FORM ELEMENTS & INPUTS */
        label {
            display: block;
            margin-top: 15px;
            font-weight: 500;
            color: #555;
        }
        input[type="date"], input[type="time"], input[type="month"], select, input[type="text"] {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1em;
        }
        select {
            appearance: none; 
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23333333" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 10px top 50%;
            background-size: 16px 16px;
        }

        .input-group {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }
        .input-group > div {
            flex: 1;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 10px;
        }

        /* BUTTONS */
        button {
            padding: 12px 20px;
            background-color: #ff5722; /* Cor prim√°ria DEV */
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 15px;
            font-weight: 600;
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        button:hover {
            background-color: #e64a19;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .btn-success { background-color: #28a745; }
        .btn-success:hover { background-color: #1e7e34; }

        .btn-warning { background-color: #ffc107; color: #333; }
        .btn-warning:hover { background-color: #e0a800; }
        
        .btn-danger { background-color: #dc3545; }
        .btn-danger:hover { background-color: #bd2130; }

        .btn-secondary { background-color: #6c757d; }
        .btn-secondary:hover { background-color: #5a6268; }

        .btn-primary { background-color: #ff5722; } /* Cor prim√°ria DEV */
        .btn-primary:hover { background-color: #e64a19; }
        
        .btn-info { background-color: #17a2b8; }
        .btn-info:hover { background-color: #138496; }


        .action-bar {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        /* NOVO ESTILO: Bot√µes de Filtro empilhados (Para a se√ß√£o de relat√≥rios) */
        .filter-buttons-stack {
            width: 100%; /* Faz o bot√£o ocupar toda a largura dispon√≠vel */
            margin-top: 10px; /* Adiciona espa√ßo entre eles */
        }
        /* Altera o container para empilhar os bot√µes */
        .filter-buttons-container {
            display: flex;
            flex-direction: column; /* Empilha os bot√µes verticalmente */
            gap: 0; 
        }

        /* ESTILO PARA INPUT DE ARQUIVO DISFAR√áADO DE BOT√ÉO */
        .file-upload-container input[type="file"] {
            display: none;
        }

        .btn-file-label {
            display: block; 
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1em;
            cursor: pointer;
            
            background-color: #f8f9fa; 
            border: 1px solid #ced4da; 
            color: #495057; 
            text-align: left;
            overflow: hidden; 
            white-space: nowrap; 
            text-overflow: ellipsis; 
            font-weight: 500;
        }
        
        .btn-file-label:hover {
            background-color: #e9ecef;
            border-color: #adb5bd;
        }
        /* FIM ESTILO NOVO */

        /* LISTS & TABLES */
        #listaMotoristas {
            list-style-type: none;
            padding: 0;
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        #listaMotoristas li {
            background: #fbe9e7; /* Cor DEV Light */
            color: #ff5722;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }
        
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 15px;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        th, td {
            border: 1px solid #dee2e6;
            padding: 10px;
            text-align: left;
        }
        th { 
            background-color: #e9ecef; 
            color: #495057;
            font-weight: 600;
        }
        caption {
            font-weight: bold;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #ff5722; /* Cor prim√°ria DEV */
            color: white;
            border-radius: 8px 8px 0 0;
        }
        .night-hours { 
            color: #880e4f; 
            font-weight: bold; 
            background-color: #fce4ec;
        }

        /* FIELDSET & LEGEND */
        fieldset {
            border: 1px solid #dee2e6;
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
            background-color: #fcfcfc;
        }
        legend {
            font-weight: 700;
            color: #ff5722; /* Cor prim√°ria DEV */
            padding: 0 10px;
            font-size: 1.1em;
            margin-left: -5px;
        }

        /* RELATORIO GERAL CARDS */
        .viagem-card-report {
            border: 1px solid #ced4da;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            background-color: #ffffff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
            /* Destaque para atraso */
            border-left: 5px solid transparent; 
        }
        .viagem-card-report.atrasada {
            border-left: 5px solid #dc3545; /* Vermelho para Atraso */
            background-color: #fff0f1;
        }
        .viagem-card-report:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .viagem-card-report h4 {
            color: #ff5722; /* Cor prim√°ria DEV */
            margin-top: 0;
            font-size: 1.1em;
        }
        .viagem-card-report.atrasada h4 {
            color: #dc3545;
        }
        .viagem-card-report .trecho-item {
            border-left: 4px solid #ff5722; /* Cor prim√°ria DEV */
            padding-left: 10px;
            margin-top: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            padding: 8px 10px;
        }
        
        /* NOVO ESTILO DE AGRUPAMENTO MENSAL */
        .mes-header {
            background-color: #ff5722;
            color: white;
            padding: 10px 15px;
            margin: 20px 0 15px 0; 
            font-size: 1.4em;
            font-weight: 700;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* MODAL */
        #detalhesModal, #justificativaModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: rgba(0,0,0,0.6); 
            display: none; 
            justify-content: center; 
            align-items: center; 
            z-index: 2000;
            backdrop-filter: blur(3px);
        }
        #detalhesContent, #justificativaContent {
            background-color: white; 
            padding: 30px; 
            border-radius: 12px; 
            width: 90%; 
            max-width: 650px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            animation: fadeIn 0.3s ease-out;
        }
        #detalhesContent h3, #justificativaContent h3 { color: #ff5722; margin-top: 0; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* RESPONSIVENESS */
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .card { padding: 15px; }
            .form-row { grid-template-columns: 1fr; }
            .input-group { flex-direction: column; gap: 0; }
            .action-bar button { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="app-header">
        <h1>üöß ViagensPro DEV - Gerenciamento de Rotas (Online)</h1>
    </div>

    <div class="container">
    
        <div class="card" id="cadastro-motoristas">
            <h2>üë§ Cadastro de Motoristas</h2>
            <div class="input-group">
                <div style="flex-grow: 1;">
                    <label for="nomeMotorista">Nome do Motorista:</label>
                    <input id="nomeMotorista" type="text" placeholder="Ex: Jo√£o da Silva" required>
                </div>
                <div style="flex-grow: 0; align-self: flex-end;">
                    <button onclick="addMotorista()" class="btn-success" style="width: auto; padding: 10px 20px;">Adicionar</button>
                </div>
            </div>
            <h3>Motoristas Cadastrados:</h3>
            <ul id="listaMotoristas"></ul>
        </div>
        
        <div class="card" id="cadastro-viagens">
            <h2>üöå Cadastro de Viagens (Trechos M√∫ltiplos)</h2>
            
            <input type="hidden" id="viagemEmEdicaoId" value="">
            <p id="mensagemEdicao" style="color: #ff5722; font-weight: bold; margin-bottom: 15px;"></p>
            
            <div class="form-row">
                <div>
                    <label for="dataViagem">Data da Viagem <span id="diaSemana" style="font-weight: normal; color: #555;"></span>:</label>
                    <input type="date" id="dataViagem" required>
                </div>
                <div>
                    <label for="rota">Rota (Destino):</label>
                    <select id="rota" onchange="updateFormLabels()" required>
                        <option value="">Selecione a Rota</option>
                        <option value="osasco-teofilo_ida">Ida: Osasco-SP ‚Üí Te√≥filo Otoni-MG (2 Trechos)</option>
                        <option value="osasco-teofilo_volta">Volta: Te√≥filo Otoni-MG ‚Üí Osasco-SP (2 Trechos)</option>
                        <option value="osasco-porto_ida">Ida: Osasco-SP ‚Üí Porto Seguro-BA (3 Trechos)</option>
                        <option value="osasco-porto_volta">Volta: Porto Seguro-BA ‚Üí Osasco-SP (3 Trechos)</option>
                    </select>
                </div>
            </div>

            <fieldset>
                <legend id="legend1">Trecho 1:</legend>
                <div class="form-row">
                    <div>
                        <label for="motorista1">Motorista 1:</label>
                        <select id="motorista1" required></select>
                    </div>
                    <div>
                        <label>In√≠cio da Jornada:</label>
                        <input type="time" id="inicio1" required>
                    </div>
                    <div>
                        <label>Fim da Jornada:</label>
                        <input type="time" id="fim1" required>
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend id="legend2">Trecho 2:</legend>
                <div class="form-row">
                    <div>
                        <label for="motorista2">Motorista 2:</label>
                        <select id="motorista2" required></select>
                    </div>
                    <div>
                        <label>In√≠cio da Jornada:</label>
                        <input type="time" id="inicio2" required>
                    </div>
                    <div>
                        <label>Fim da Jornada:</label>
                        <input type="time" id="fim2" required>
                    </div>
                </div>
            </fieldset>

            <fieldset id="fieldset3" style="display: none;">
                <legend id="legend3">Trecho 3:</legend>
                <div class="form-row">
                    <div>
                        <label for="motorista3">Motorista 3:</label>
                        <select id="motorista3" required></select>
                    </div>
                    <div>
                        <label>In√≠cio da Jornada:</label>
                        <input type="time" id="inicio3" required>
                    </div>
                    <div>
                        <label>Fim da Jornada:</label>
                        <input type="time" id="fim3" required>
                    </div>
                </div>
            </fieldset>

            <div class="action-bar">
                <button onclick="addViagem()" class="btn-success">Salvar Viagem</button>
                <button onclick="limparFormularioViagem()" class="btn-secondary">Cancelar Edi√ß√£o / Limpar</button>
            </div>
        </div>
        
        <div class="card" id="relatorios-e-analises">
            <h2>üìä Relat√≥rios e An√°lises</h2>
            
            <div style="margin-bottom: 25px; padding: 15px; border: 1px dashed #ff5722; border-radius: 8px;">
                <h3 style="color: #495057; border: none; padding-bottom: 0;">Filtro de Per√≠odo</h3>
                
                <div class="form-row" style="margin-top: 10px;">
                    <div style="max-width: 300px;">
                        <label for="mesAno">M√™s/Ano do Relat√≥rio:</label>
                        <input type="month" id="mesAno" required>
                    </div>
                    
                    <div class="filter-buttons-container" style="align-self: flex-end; flex-grow: 1;">
                        <button onclick="gerarRelatorio()" class="btn-secondary filter-buttons-stack">Relat√≥rio de Horas de Motoristas</button>
                        <button onclick="gerarRelatorioGeralViaForm()" class="btn-primary filter-buttons-stack">Visualizar Viagens (Cards)</button>
                        <button onclick="gerarRelatorioAtrasosViaForm()" class="btn-info filter-buttons-stack">Viagens Atrasadas</button>
                    </div>
                </div>
            </div>

            <div class="action-bar" style="margin-top: 0;">
                <button onclick="gerarMediaPorTrecho()" class="btn-secondary">Calcular M√©dia por Trecho</button>
            </div>

            <hr style="margin: 30px 0;">
            <div id="relatorios">
                <p style="text-align: center; color: #6c757d;">Os relat√≥rios ser√£o exibidos aqui ap√≥s a gera√ß√£o.</p>
            </div>
        </div>
        
        <div class="card" id="gerenciamento-dados">
            <h2>‚öôÔ∏è Gerenciamento de Dados (DEV - Firebase)</h2>
            
            <div style="margin-bottom: 25px; padding: 15px; border: 1px solid #ced4da; border-radius: 8px;">
                <h3 style="color: #495057; border: none; padding-bottom: 0;">Exportar Dados (Backup Local)</h3>
                <p style="font-size: 0.9em; color: #6c757d;">
                    Cria um arquivo JSON local dos dados atualmente carregados do Firebase.
                </p>
                <div class="action-bar" style="margin-top: 0;">
                    <button onclick="exportData()" class="btn-secondary" style="width: auto;">Exportar Dados DEV (JSON)</button>
                </div>
            </div>

            <div style="margin-bottom: 25px; padding: 15px; border: 1px solid #ced4da; border-radius: 8px;">
                <h3 style="color: #495057; margin-top: 0; border: none; padding-bottom: 0;">Importar Dados (JSON p/ Firebase)</h3>
                <p style="font-size: 0.9em; color: #6c757d;">
                    Carrega motoristas e viagens a partir de um arquivo JSON local e **SOBRESCREVE** o Firebase.
                </p>
                <div class="form-row">
                    <div class="file-upload-container" style="flex-grow: 1;">
                        <label>Arquivo de Importa√ß√£o (.json):</label>
                        <label for="importFile" id="importFileLabel" class="btn-file-label">
                            Nenhum arquivo escolhido
                        </label>
                        <input type="file" id="importFile" accept=".json" onchange="updateFileName()">
                    </div>
                    <div style="align-self: flex-end; display: flex;">
                        <button onclick="importData()" class="btn-success" style="width: auto;">Importar</button>
                    </div>
                </div>
            </div>
            
            <hr style="margin: 30px 0;">
            
            <h3 style="color: #495057; margin-top: 20px;">Limpeza Total</h3>
            <p style="font-size: 0.9em; color: #6c757d;">
                Exclui permanentemente todos os dados DEV salvos no **Firebase Firestore**.
            </p>
            <div class="action-bar">
                <button onclick="clearData()" class="btn-danger">Limpar TODOS os Dados DEV (Online)</button>
            </div>
        </div>
        </div> <div id="detalhesModal">
        <div id="detalhesContent">
            <h3 id="detalhesTitulo"></h3>
            <p id="detalhesCorpo"></p>
            <div class="action-bar" style="justify-content: flex-end;">
                <button id="btnEditarModal" class="btn-warning">Editar Viagem</button>
                <button onclick="document.getElementById('detalhesModal').style.display = 'none'" class="btn-secondary">Fechar</button>
            </div>
        </div>
    </div>
    
    <div id="justificativaModal">
        <div id="justificativaContent">
            <h3 style="color: #dc3545;">üö® Justificar Atraso</h3>
            <p id="justificativaHeader"></p>
            <input type="hidden" id="atrasoViagemId" value="">
            
            <label for="motivoAtraso">Selecione a Justificativa:</label>
            <select id="motivoAtraso" required>
                <option value="">Selecione...</option>
                <option value="Carro saiu atrasado">Carro saiu atrasado</option>
                <option value="Problema mec√¢nico">Problema mec√¢nico</option>
                <option value="Pneu furado">Pneu furado</option>
                <option value="Estrada interditada">Estrada interditada</option>
                <option value="Tr√¢nsito">Tr√¢nsito</option>
            </select>

            <div class="action-bar" style="justify-content: flex-end;">
                <button onclick="salvarJustificativa()" class="btn-danger">Salvar Justificativa</button>
                <button onclick="document.getElementById('justificativaModal').style.display = 'none'" class="btn-secondary">Cancelar</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        // --- CONFIGURA√á√ÉO E INICIALIZA√á√ÉO DO FIREBASE (SUAS CHAVES) ---
        
        import { initializeApp } from "https://www.gstatic.com/firebase/9/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebase/9/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCKKVtLUKRWhMvdsQInr4saBMO8PO1PZ2k",
            authDomain: "cadastro-de-viagens.firebaseapp.com",
            projectId: "cadastro-de-viagens",
            storageBucket: "cadastro-de-viagens.firebasestorage.app",
            messagingSenderId: "366307042816",
            appId: "1:366307042816:web:93bb38413a0e5e26689ae5"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // DOCUMENTO √öNICO PARA SALVAR TODOS OS DADOS DO PROJETO DEV
        const DOC_PATH = "dev_data";
        const COLLECTION_NAME = "viagens_pro_db"; 
        
        // --- CONFIGURA√á√ÉO DE ROTAS E METAS (INALTERADO) ---
        const ROTAS_CONFIG = {
            'osasco-teofilo_ida': [
                { chegadaMeta: '01:30', toleranciaMin: 30 }, 
                { chegadaMeta: '10:30', toleranciaMin: 30 }
            ],
            'osasco-teofilo_volta': [
                { chegadaMeta: '22:30', toleranciaMin: 30 },
                { chegadaMeta: '11:00', toleranciaMin: 30 }
            ],
            'osasco-porto_ida': [
                { chegadaMeta: '20:30', toleranciaMin: 30 },
                { chegadaMeta: '04:00', toleranciaMin: 30 },
                { chegadaMeta: '14:00', toleranciaMin: 30 }
            ],
            'osasco-porto_volta': [
                { chegadaMeta: '21:30', toleranciaMin: 30 },
                { chegadaMeta: '06:30', toleranciaMin: 30 },
                { chegadaMeta: '17:00', toleranciaMin: 60 }
            ]
        };

        // Vari√°veis globais (carregadas do Firebase)
        let motoristas = [];
        let viagens = [];
        
        // --- NOVAS FUN√á√ïES DE PERSIST√äNCIA (FIREBASE) ---
        
        async function loadData() {
            try {
                const docRef = doc(db, COLLECTION_NAME, DOC_PATH);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    motoristas = data.motoristas || [];
                    viagens = data.viagens || [];
                    console.log("Dados carregados do Firestore com sucesso.");
                } else {
                    console.log("Nenhum dado encontrado no Firestore. Iniciando com dados vazios.");
                }
            } catch (e) {
                console.error("Erro ao carregar dados do Firestore:", e);
                alert("Erro ao carregar dados online. Verifique sua conex√£o e se as regras do Firebase est√£o corretas.");
            } finally {
                updateMotoristasList();
            }
        }

        async function saveData() {
            try {
                await setDoc(doc(db, COLLECTION_NAME, DOC_PATH), {
                    motoristas: motoristas,
                    viagens: viagens,
                    timestamp: new Date().toISOString()
                });
                console.log("Dados salvos no Firestore com sucesso.");
            } catch (e) {
                console.error("Erro ao salvar dados no Firestore:", e);
                alert("Erro ao salvar dados online. A altera√ß√£o pode n√£o ter sido persistida.");
            }
        }

        async function clearData() {
            if (confirm('Tem certeza que deseja APAGAR TODOS OS DADOS DEV do Firebase? Esta a√ß√£o √© IRREVERS√çVEL!')) {
                try {
                    await setDoc(doc(db, COLLECTION_NAME, DOC_PATH), {
                        motoristas: [],
                        viagens: [],
                        timestamp: new Date().toISOString()
                    });
                    motoristas = [];
                    viagens = [];
                    updateMotoristasList();
                    document.getElementById('relatorios').innerHTML = '<p style="text-align: center; color: #6c757d;">Todos os dados DEV do Firebase foram apagados com sucesso.</p>';
                    alert('Todos os dados DEV do Firebase foram apagados com sucesso.');
                } catch (e) {
                    console.error("Erro ao limpar dados do Firestore:", e);
                    alert("Erro ao tentar apagar dados no Firebase.");
                }
            }
        }
        
        // --- FUN√á√ïES DE HORA ---

        function timeToMinutes(time) {
            if (!time) return 0;
            const [h, m] = time.split(':').map(Number);
            return h * 60 + m;
        }

        function formatHours(decimalHours) {
            const h = Math.floor(decimalHours);
            const m = Math.round((decimalHours - h) * 60);
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
        }
        
        function totalHoursToDecimal(hours) {
            return hours.toFixed(2);
        }

        function calculateHours(start, end) {
            const [sh, sm] = start.split(':').map(Number);
            const [eh, em] = end.split(':').map(Number);
            let hours = (eh - sh) + (em - sm) / 60;
            if (hours < 0) hours += 24;
            return hours;
        }

        function calculateNightHours(start, end) {
            const NIGHT_START_TIME = 22 * 60; 
            const NIGHT_END_TIME = 5 * 60;   
            const DAY_MINUTES = 24 * 60;     

            const timeToMinutes = (time) => {
                const [h, m] = time.split(':').map(Number);
                return h * 60 + m;
            };

            let startMinutes = timeToMinutes(start);
            let endMinutes = timeToMinutes(end);
            let totalNightMinutes = 0;

            if (endMinutes < startMinutes) {
                endMinutes += DAY_MINUTES; 
            }

            const nightPart1Start = NIGHT_START_TIME; 
            const nightPart1End = DAY_MINUTES;        

            const overlap1Start = Math.max(startMinutes, nightPart1Start);
            const overlap1End = Math.min(endMinutes, nightPart1End);

            if (overlap1End > overlap1Start) {
                totalNightMinutes += (overlap1End - overlap1Start);
            }

            const nightPart2Start = DAY_MINUTES;             
            const nightPart2End = DAY_MINUTES + NIGHT_END_TIME; 

            const overlap2Start = Math.max(startMinutes, nightPart2Start);
            const overlap2End = Math.min(endMinutes, nightPart2End);

            if (overlap2End > overlap2Start) {
                totalNightMinutes += (overlap2End - overlap2Start);
            }

            return totalNightMinutes / 60; 
        }

        // --- FUN√á√ïES DE VIAGEM E MOTORISTAS ---
        
        function createViagemId(data, inicio1) {
            return `${data}T${inicio1}`;
        }
        
        async function addMotorista() {
            const nome = document.getElementById('nomeMotorista').value.trim();
            if (nome && !motoristas.includes(nome)) {
                motoristas.push(nome);
                await saveData();
                updateMotoristasList();
                document.getElementById('nomeMotorista').value = '';
            } else if (nome) {
                alert('Motorista j√° cadastrado.');
            } else {
                alert('Por favor, digite o nome do motorista.');
            }
        }
        
        async function addViagem() {
            const rota = document.getElementById('rota').value;
            const data = document.getElementById('dataViagem').value;
            const isThreeTrecho = rota.includes('porto');
            
            const m1 = document.getElementById('motorista1').value;
            const inicio1 = document.getElementById('inicio1').value;
            const fim1 = document.getElementById('fim1').value;
            const m2 = document.getElementById('motorista2').value;
            const inicio2 = document.getElementById('inicio2').value;
            const fim2 = document.getElementById('fim2').value;
            
            const viagemEmEdicaoId = document.getElementById('viagemEmEdicaoId').value; 
            
            if (!rota || !data || !m1 || !inicio1 || !fim1 || !m2 || !inicio2 || !fim2) {
                alert('Preencha todos os campos obrigat√≥rios.');
                return;
            }

            const novoViagemId = createViagemId(data, inicio1); 

            let m3, inicio3, fim3, hours3 = 0, nightHours3 = 0, trecho3Nome = null;
            
            const hours1 = calculateHours(inicio1, fim1);
            const nightHours1 = calculateNightHours(inicio1, fim1);
            const hours2 = calculateHours(inicio2, fim2);
            const nightHours2 = calculateNightHours(inicio2, fim2);

            if (isThreeTrecho) {
                m3 = document.getElementById('motorista3').value;
                inicio3 = document.getElementById('inicio3').value;
                fim3 = document.getElementById('fim3').value;
                if (!m3 || !inicio3 || !fim3) {
                    alert('Preencha os campos do Terceiro Trecho.');
                    return;
                }
                hours3 = calculateHours(inicio3, fim3);
                nightHours3 = calculateNightHours(inicio3, fim3);
            }

            let trecho1Nome, trecho2Nome;
            switch (rota) {
                case 'osasco-teofilo_ida':
                    trecho1Nome = 'Osasco-SP ‚Üí Belo Horizonte-MG';
                    trecho2Nome = 'Belo Horizonte-MG ‚Üí Te√≥filo Otoni-MG';
                    break;
                case 'osasco-teofilo_volta':
                    trecho1Nome = 'Te√≥filo Otoni-MG ‚Üí Belo Horizonte-MG';
                    trecho2Nome = 'Belo Horizonte-MG ‚Üí Osasco-SP';
                    break;
                case 'osasco-porto_ida':
                    trecho1Nome = 'Osasco-SP ‚Üí Belo Horizonte-MG';
                    trecho2Nome = 'Belo Horizonte-MG ‚Üí Te√≥filo Otoni-MG';
                    trecho3Nome = 'Te√≥filo Otoni-MG ‚Üí Porto Seguro-BA';
                    break;
                case 'osasco-porto_volta':
                    trecho1Nome = 'Porto Seguro-BA ‚Üí Te√≥filo Otoni-MG';
                    trecho2Nome = 'Te√≥filo Otoni-MG ‚Üí Belo Horizonte-MG';
                    trecho3Nome = 'Belo Horizonte-MG ‚Üí Osasco-SP';
                    break;
            }

            const trechos = [
                { nome: trecho1Nome, motorista: m1, inicio: inicio1, fim: fim1, horas: hours1, horasNoturnas: nightHours1 },
                { nome: trecho2Nome, motorista: m2, inicio: inicio2, fim: fim2, horas: hours2, horasNoturnas: nightHours2 }
            ];
            if (isThreeTrecho) {
                trechos.push({ nome: trecho3Nome, motorista: m3, inicio: inicio3, fim: fim3, horas: hours3, horasNoturnas: nightHours3 });
            }
            
            const dateObj = new Date(data + 'T00:00:00');
            const day = dateObj.toLocaleDateString('pt-BR', { weekday: 'long' }).toLowerCase();
            
            
            // --- L√ìGICA DE ATRASO AO SALVAR (Verifica o √öLTIMO Trecho) ---
            let isAtrasada = false;
            let atrasoJustificativa = '';
            
            const ultimoTrecho = trechos[trechos.length - 1];
            const ultimoTrechoIndex = trechos.length - 1;
            const configUltimoTrecho = ROTAS_CONFIG[rota][ultimoTrechoIndex];

            if (configUltimoTrecho) {
                const [metaH, metaM] = configUltimoTrecho.chegadaMeta.split(':').map(Number);
                const toleranciaMin = configUltimoTrecho.toleranciaMin;
                let metaTotalMin = metaH * 60 + metaM + toleranciaMin;
                
                const [chegadaH, chegadaM] = ultimoTrecho.fim.split(':').map(Number);
                let chegadaTotalMin = chegadaH * 60 + chegadaM;
                
                const inicioUltimoTrechoMin = timeToMinutes(ultimoTrecho.inicio);

                if (chegadaTotalMin < inicioUltimoTrechoMin) {
                    chegadaTotalMin += (24 * 60);
                }
                
                if (metaTotalMin < inicioUltimoTrechoMin) {
                    metaTotalMin += (24 * 60); 
                }
                
                if (chegadaTotalMin > metaTotalMin) {
                    isAtrasada = true;
                    atrasoJustificativa = 'Aguardando justificativa';
                    alert('AVISO: Esta viagem est√° registrada como ATRASADA no destino final. Por favor, utilize o novo relat√≥rio para justificar.');
                }
            }

            const viagemAtualizada = {
                id: novoViagemId, 
                data,
                day, 
                rota,
                trechos: trechos,
                atraso: {
                    isAtrasada: isAtrasada,
                    justificativa: atrasoJustificativa 
                }
            };
            
            if (viagemEmEdicaoId) {
                const index = viagens.findIndex(v => v.id === viagemEmEdicaoId);

                if (viagemEmEdicaoId !== novoViagemId && viagens.some(v => v.id === novoViagemId)) {
                     alert(`Erro: J√° existe uma viagem cadastrada nesta data/hor√°rio de in√≠cio (${data} √†s ${inicio1}).`);
                     return;
                }

                if (index !== -1) {
                    // Mant√©m a justificativa anterior se a viagem ainda estiver atrasada
                    if (viagens[index].atraso && viagens[index].atraso.justificativa !== 'Aguardando justificativa' && isAtrasada) {
                        viagemAtualizada.atraso.justificativa = viagens[index].atraso.justificativa;
                    }
                    viagens[index] = viagemAtualizada;
                    alert(`Viagem de ${data} (In√≠cio: ${inicio1}) editada com sucesso.`);
                } else {
                    alert('Erro: Viagem original n√£o encontrada para edi√ß√£o.');
                }
            } else {
                if (viagens.some(v => v.id === novoViagemId)) {
                     alert(`Erro: J√° existe uma viagem cadastrada nesta data/hor√°rio de in√≠cio (${data} √†s ${inicio1}).`);
                     return;
                }
                viagens.push(viagemAtualizada);
                alert(`Viagem da rota ${rota} cadastrada com sucesso.`);
            }
            
            await saveData();
            limparFormularioViagem();
        }

        async function salvarJustificativa() {
            const viagemId = document.getElementById('atrasoViagemId').value;
            const motivo = document.getElementById('motivoAtraso').value;

            if (!motivo) {
                alert('Por favor, selecione uma justificativa.');
                return;
            }

            const viagemIndex = viagens.findIndex(v => v.id === viagemId);
            if (viagemIndex !== -1) {
                viagens[viagemIndex].atraso.justificativa = motivo;
                await saveData(); 
                document.getElementById('justificativaModal').style.display = 'none';
                
                const mesAno = document.getElementById('mesAno').value;
                if (mesAno) {
                    gerarRelatorioAtrasos(mesAno);
                }
            } else {
                alert('Erro: Viagem n√£o encontrada.');
            }
        }
        
        function updateMotoristasList() {
            const lista = document.getElementById('listaMotoristas');
            lista.innerHTML = '';
            motoristas.forEach(m => {
                const li = document.createElement('li');
                li.textContent = m;
                lista.appendChild(li);
            });
            
            const selects = [document.getElementById('motorista1'), document.getElementById('motorista2'), document.getElementById('motorista3')];
            selects.forEach(select => {
                const currentValue = select.value; 
                select.innerHTML = '<option value="">Selecione</option>';
                motoristas.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m;
                    opt.textContent = m;
                    select.appendChild(opt.cloneNode(true));
                });
                if (motoristas.includes(currentValue)) {
                    select.value = currentValue;
                }
            });
        }
        
        function limparFormularioViagem() {
            document.getElementById('viagemEmEdicaoId').value = ''; 
            document.getElementById('mensagemEdicao').textContent = '';
            document.getElementById('rota').value = '';
            updateFormLabels(); 
            document.getElementById('dataViagem').value = '';
            document.getElementById('diaSemana').textContent = '';
            document.getElementById('motorista1').value = '';
            document.getElementById('inicio1').value = '';
            document.getElementById('fim1').value = '';
            document.getElementById('motorista2').value = '';
            document.getElementById('inicio2').value = '';
            document.getElementById('fim2').value = '';
            document.getElementById('motorista3').value = '';
            document.getElementById('inicio3').value = '';
            document.getElementById('fim3').value = '';

            document.querySelector('.card#cadastro-viagens').scrollIntoView({ behavior: 'smooth' });
        }

        function updateFormLabels() {
            const rota = document.getElementById('rota').value;
            const legend1 = document.getElementById('legend1');
            const legend2 = document.getElementById('legend2');
            const legend3 = document.getElementById('legend3');
            const fieldset3 = document.getElementById('fieldset3');

            legend1.textContent = 'Trecho 1:';
            legend2.textContent = 'Trecho 2:';
            legend3.textContent = 'Trecho 3:';
            fieldset3.style.display = 'none';

            if (rota === 'osasco-teofilo_ida') {
                legend1.textContent = 'Trecho 1: Osasco-SP ‚Üí Belo Horizonte-MG';
                legend2.textContent = 'Trecho 2: Belo Horizonte-MG ‚Üí Te√≥filo Otoni-MG';
            } else if (rota === 'osasco-teofilo_volta') {
                legend1.textContent = 'Trecho 1: Te√≥filo Otoni-MG ‚Üí Belo Horizonte-MG';
                legend2.textContent = 'Trecho 2: Belo Horizonte-MG ‚Üí Osasco-SP';
            } else if (rota === 'osasco-porto_ida') {
                legend1.textContent = 'Trecho 1: Osasco-SP ‚Üí Belo Horizonte-MG';
                legend2.textContent = 'Trecho 2: Belo Horizonte-MG ‚Üí Te√≥filo Otoni-MG';
                legend3.textContent = 'Trecho 3: Te√≥filo Otoni-MG ‚Üí Porto Seguro-BA';
                fieldset3.style.display = 'block';
            } else if (rota === 'osasco-porto_volta') {
                legend1.textContent = 'Trecho 1: Porto Seguro-BA ‚Üí Te√≥filo Otoni-MG';
                legend2.textContent = 'Trecho 2: Te√≥filo Otoni-MG ‚Üí Belo Horizonte-MG';
                legend3.textContent = 'Trecho 3: Belo Horizonte-MG ‚Üí Osasco-SP';
                fieldset3.style.display = 'block';
            }
            const isThreeTrecho = rota.includes('porto');
            document.getElementById('motorista3').required = isThreeTrecho;
            document.getElementById('inicio3').required = isThreeTrecho;
            document.getElementById('fim3').required = isThreeTrecho;
        }

        document.getElementById('dataViagem').addEventListener('change', function() {
            const data = this.value;
            if (data) {
                const dateObj = new Date(data + 'T00:00:00'); 
                const day = dateObj.toLocaleDateString('pt-BR', { weekday: 'long' });
                document.getElementById('diaSemana').textContent = ` (${day[0].toUpperCase()}${day.slice(1)})`;
            } else {
                document.getElementById('diaSemana').textContent = '';
            }
        });
        
        function editarViagem(viagemId) { 
            const viagem = viagens.find(v => v.id === viagemId); 
            
            if (!viagem) {
                alert('Viagem n√£o encontrada para edi√ß√£o.');
                return;
            }
            
            document.getElementById('detalhesModal').style.display = 'none';

            document.getElementById('viagemEmEdicaoId').value = viagemId; 
            document.getElementById('mensagemEdicao').textContent = `EDITANDO VIAGEM de ${viagem.data.split('-').reverse().join('/')} (In√≠cio Trecho 1: ${viagem.trechos[0].inicio}).`;
            
            document.querySelector('.card#cadastro-viagens').scrollIntoView({ behavior: 'smooth' });

            document.getElementById('rota').value = viagem.rota;
            updateFormLabels(); 
            
            document.getElementById('dataViagem').value = viagem.data;
            document.getElementById('dataViagem').dispatchEvent(new Event('change')); 

            document.getElementById('motorista1').value = viagem.trechos[0].motorista;
            document.getElementById('inicio1').value = viagem.trechos[0].inicio;
            document.getElementById('fim1').value = viagem.trechos[0].fim;

            document.getElementById('motorista2').value = viagem.trechos[1].motorista;
            document.getElementById('inicio2').value = viagem.trechos[1].inicio;
            document.getElementById('fim2').value = viagem.trechos[1].fim;

            if (viagem.trechos.length > 2) {
                document.getElementById('motorista3').value = viagem.trechos[2].motorista;
                document.getElementById('inicio3').value = viagem.trechos[2].inicio;
                document.getElementById('fim3').value = viagem.trechos[2].fim;
                document.getElementById('fieldset3').style.display = 'block';
            } else {
                 document.getElementById('motorista3').value = '';
                document.getElementById('inicio3').value = '';
                document.getElementById('fim3').value = '';
                document.getElementById('fieldset3').style.display = 'none';
            }
        }
        
        function mostrarDetalhesViagem(viagemId, motorista) { 
            const viagem = viagens.find(v => v.id === viagemId); 

            if (!viagem) {
                alert('Detalhes da viagem n√£o encontrados.');
                return;
            }

            let detalhesHTML = `<p><strong>Rota:</strong> ${viagem.rota.toUpperCase()}</p>`;
            
            if (viagem.atraso && viagem.atraso.isAtrasada) {
                detalhesHTML += `<p style="color: #dc3545; font-weight: bold; border: 1px dashed #dc3545; padding: 5px; border-radius: 4px;">üö® ATRASADA: ${viagem.atraso.justificativa || 'Aguardando justificativa'}</p>`;
            }
            detalhesHTML += `<hr>`;
            
            viagem.trechos.forEach((trecho, index) => {
                const isMotoristaNaViagem = motorista && trecho.motorista === motorista;
                const highlightStyle = isMotoristaNaViagem ? 'style="background-color: #fbe9e7; border: 1px solid #ff5722; padding: 10px; border-radius: 6px; margin-top: 10px;"' : 'style="border: 1px solid #f0f0f0; padding: 10px; border-radius: 6px; margin-top: 10px;"';

                const nightHours = trecho.horasNoturnas !== undefined ? totalHoursToDecimal(trecho.horasNoturnas) : '0.00';
                
                detalhesHTML += `<div ${highlightStyle}>`;
                detalhesHTML += `<h4 style="margin: 0; color: #495057;">Trecho ${index + 1} (${trecho.nome}):</h4>`;
                detalhesHTML += `<p style="margin: 5px 0;"><strong>Motorista:</strong> ${trecho.motorista}</p>`;
                detalhesHTML += `<p style="margin: 5px 0;"><strong>Hor√°rio:</strong> ${trecho.inicio} ‚Üí ${trecho.fim}</p>`;
                detalhesHTML += `<p style="margin: 5px 0;"><strong>Horas Totais:</strong> ${totalHoursToDecimal(trecho.horas)} h | <span class="night-hours" style="background-color: transparent;">Noturnas: ${nightHours} h</span></p>`;
                
                const config = ROTAS_CONFIG[viagem.rota];
                if (config && config[index]) {
                     const isLastTrecho = index === viagem.trechos.length - 1;
                     const targetInfo = isLastTrecho ? `<br>Meta Chegada Destino: ${config[index].chegadaMeta} (Toler√¢ncia: ${config[index].toleranciaMin} min)` : '';
                     detalhesHTML += `<p style="margin: 5px 0; font-size: 0.9em; color: #6c757d;">${targetInfo}</p>`;
                }

                detalhesHTML += `</div>`;
            });

            document.getElementById('detalhesTitulo').textContent = `Detalhes da Viagem de ${viagem.data.split('-').reverse().join('/')} (In√≠cio: ${viagem.trechos[0].inicio})`;
            document.getElementById('detalhesCorpo').innerHTML = detalhesHTML;
            
            document.getElementById('btnEditarModal').setAttribute('onclick', `editarViagem('${viagemId}')`);
            
            document.getElementById('detalhesModal').style.display = 'flex';
        }

        function gerarMediaPorTrecho() {
            const rel = document.getElementById('relatorios');
            rel.innerHTML = '';

            if (viagens.length === 0) {
                rel.innerHTML = '<h3>M√©dia por Trecho</h3><p>Nenhuma viagem cadastrada para calcular a m√©dia.</p>';
                return;
            }

            const trechosData = {}; 

            viagens.forEach(v => {
                v.trechos.forEach(trecho => {
                    const trechoNome = trecho.nome;
                    const horas = trecho.horas;

                    if (!trechosData[trechoNome]) {
                        trechosData[trechoNome] = { totalHours: 0, count: 0 };
                    }

                    trechosData[trechoNome].totalHours += horas;
                    trechosData[trechoNome].count += 1;
                });
            });

            const table = document.createElement('table');
            const caption = document.createElement('caption');
            caption.textContent = `Tempo M√©dio de Viagem por Trecho (Baseado em ${viagens.length} Viagens DEV)`;
            table.appendChild(caption);

            const thead = document.createElement('thead');
            const trh = document.createElement('tr');
            ['Trecho', 'M√©dia de Horas (h)', 'Viagens Contabilizadas'].forEach(headerText => {
                const th = document.createElement('th'); th.textContent = headerText; trh.appendChild(th);
            });
            thead.appendChild(trh);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            
            const trechosOrdenados = Object.keys(trechosData).sort();

            trechosOrdenados.forEach(trechoNome => {
                const data = trechosData[trechoNome];
                const mediaHours = data.totalHours / data.count;
                
                const tr = document.createElement('tr');
                
                const td1 = document.createElement('td'); td1.textContent = trechoNome; 
                const td2 = document.createElement('td'); td2.textContent = totalHoursToDecimal(mediaHours);
                const td3 = document.createElement('td'); td3.textContent = data.count;
                
                tr.appendChild(td1);
                tr.appendChild(td2);
                tr.appendChild(td3);
                tbody.appendChild(tr);
            });

            table.appendChild(tbody);
            rel.innerHTML = '';
            rel.appendChild(table);
        }
        
        function gerarRelatorioGeralViaForm() {
            const mesAno = document.getElementById('mesAno').value;
            if (!mesAno) {
                alert('Por favor, selecione o M√™s/Ano no campo de filtro.');
                return;
            }
            gerarRelatorioGeral(mesAno);
        }

        function gerarRelatorioGeral(filterMonthYear) {
            const rel = document.getElementById('relatorios');
            rel.innerHTML = '';
            
            if (viagens.length === 0) {
                rel.innerHTML = '<h3>Relat√≥rio Geral de Viagens</h3><p style="text-align: center;">Nenhuma viagem cadastrada.</p>';
                return;
            }
            
            if (!filterMonthYear) {
                rel.innerHTML = '<h3>Relat√≥rio Geral de Viagens</h3><p style="text-align: center;">Por favor, selecione o M√™s/Ano no campo de filtro para visualizar.</p>';
                return;
            }

            const viagensDoMes = [...viagens]
                .filter(v => v.data.substring(0, 7) === filterMonthYear)
                .sort((a, b) => a.id.localeCompare(b.id)); 

            const [year, month] = filterMonthYear.split('-');
            const date = new Date(year, month - 1);
            const mesFormatado = date.toLocaleDateString('pt-BR', { year: 'numeric', month: 'long' });

            if (viagensDoMes.length === 0) {
                rel.innerHTML = `<h3>Relat√≥rio de Viagens - ${mesFormatado}</h3><p style="text-align: center;">Nenhuma viagem encontrada para o m√™s/ano selecionado.</p>`;
                return;
            }
            
            let html = `<h3>Relat√≥rio de Viagens Filtrado (DEV) - ${mesFormatado}</h3>`;
            
            html += `<div class="mes-header">üóìÔ∏è ${mesFormatado.toUpperCase()}</div>`;

            viagensDoMes.forEach(viagem => {
                const formattedDate = viagem.data.split('-').reverse().join('/');
                const totalHours = viagem.trechos.reduce((sum, trecho) => sum + trecho.horas, 0);
                const dayDisplay = viagem.day[0].toUpperCase() + viagem.day.slice(1);
                
                const cardClass = viagem.atraso && viagem.atraso.isAtrasada ? 'viagem-card-report atrasada' : 'viagem-card-report';
                const atrasoInfo = viagem.atraso && viagem.atraso.isAtrasada ? 
                    `<p style="color: #dc3545; margin-bottom: 5px;">üö® ATRASADA: ${viagem.atraso.justificativa || 'Aguardando justificativa'}</p>` : '';

                html += `<div class="${cardClass}">`;
                html += `<h4>${formattedDate} (${dayDisplay}) | In√≠cio: ${viagem.trechos[0].inicio}</h4>`; 
                html += atrasoInfo;
                html += `<p style="margin-top: -10px;">Rota: <strong>${viagem.rota.toUpperCase()}</strong> | Total na Jornada: <strong>${totalHoursToDecimal(totalHours)} h</strong></p>`;
                
                html += '<p style="font-weight: 600; margin-top: 15px; margin-bottom: 5px;">Detalhes dos Trechos:</p>';
                viagem.trechos.forEach((trecho, index) => {
                    const nightHours = trecho.horasNoturnas !== undefined ? totalHoursToDecimal(trecho.horasNoturnas) : '0.00';
                    html += `<div class="trecho-item">`;
                    html += `<p style="margin: 0;"><strong>Trecho ${index + 1} (${trecho.nome}):</strong></p>`;
                    html += `<p style="margin: 3px 0 0 0; font-size: 0.9em;">Motorista: ${trecho.motorista}, Hor√°rio: ${trecho.inicio} - ${trecho.fim} (${totalHoursToDecimal(trecho.horas)} h)</p>`;
                    html += `<span class="night-hours" style="font-size: 0.9em;">Horas Noturnas: ${nightHours} h</span>`;
                    
                    const config = ROTAS_CONFIG[viagem.rota];
                    if (config && index === viagem.trechos.length - 1) {
                         html += `<p style="margin: 0; font-size: 0.8em; color: #007bff;">Meta Chegada: ${config[index].chegadaMeta} + ${config[index].toleranciaMin} min</p>`;
                    }
                    html += `</div>`;
                });
                
                html += `<div class="action-bar" style="margin-top: 10px;">`;
                html += `<button class="btn-primary" style="padding: 8px 15px;" onclick="mostrarDetalhesViagem('${viagem.id}')">Ver Detalhes</button>`; 
                html += `<button class="btn-warning" style="padding: 8px 15px;" onclick="editarViagem('${viagem.id}')">Editar</button>`;
                html += `</div>`;

                html += `</div>`;
            });

            rel.innerHTML = html;
        }
        
        function gerarRelatorioAtrasosViaForm() {
            const mesAno = document.getElementById('mesAno').value;
            if (!mesAno) {
                alert('Por favor, selecione o M√™s/Ano no campo de filtro.');
                return;
            }
            gerarRelatorioAtrasos(mesAno);
        }

        function abrirJustificativaModal(viagemId) {
            const viagem = viagens.find(v => v.id === viagemId);
            if (!viagem) return;
            
            document.getElementById('atrasoViagemId').value = viagemId;
            document.getElementById('justificativaHeader').textContent = 
                `Viagem de ${viagem.data.split('-').reverse().join('/')} (${viagem.rota.toUpperCase()}) est√° atrasada.`;
            
            document.getElementById('motivoAtraso').value = 
                (viagem.atraso && viagem.atraso.justificativa && viagem.atraso.justificativa !== 'Aguardando justificativa') ? 
                viagem.atraso.justificativa : '';

            document.getElementById('justificativaModal').style.display = 'flex';
        }
        
        function gerarRelatorioAtrasos(filterMonthYear) {
            const rel = document.getElementById('relatorios');
            rel.innerHTML = '';
            
            const viagensDoMes = [...viagens]
                .filter(v => v.data.substring(0, 7) === filterMonthYear);

            const atrasadas = viagensDoMes.filter(v => v.atraso && v.atraso.isAtrasada).sort((a, b) => a.id.localeCompare(b.id));

            const [year, month] = filterMonthYear.split('-');
            const date = new Date(year, month - 1);
            const mesFormatado = date.toLocaleDateString('pt-BR', { year: 'numeric', month: 'long' });

            let html = `<h3>üö® Relat√≥rio de Viagens Atrasadas - ${mesFormatado}</h3>`;
            
            if (atrasadas.length === 0) {
                html += `<p style="text-align: center;">Nenhuma viagem atrasada registrada para o per√≠odo selecionado.</p>`;
                rel.innerHTML = html;
                return;
            }
            
            html += `<div class="mes-header">Viagens Atrasadas: ${atrasadas.length}</div>`;

            atrasadas.forEach(viagem => {
                const formattedDate = viagem.data.split('-').reverse().join('/');
                const justificativa = viagem.atraso.justificativa;
                const ultimoTrecho = viagem.trechos[viagem.trechos.length - 1];
                const ultimoTrechoIndex = viagem.trechos.length - 1;
                const config = ROTAS_CONFIG[viagem.rota][ultimoTrechoIndex];

                html += `<div class="viagem-card-report atrasada">`;
                html += `<h4>${formattedDate} | Rota: ${viagem.rota.toUpperCase()}</h4>`; 
                
                html += `<p style="margin-top: -10px; color: #dc3545; font-weight: bold;">Chegada Efetiva: ${ultimoTrecho.fim} (Meta: ${config.chegadaMeta} + ${config.toleranciaMin} min)</p>`;
                
                html += `<p><strong>Justificativa Atual:</strong> ${justificativa || 'Aguardando justificativa'}</p>`;
                
                html += `<div class="action-bar" style="margin-top: 10px;">`;
                html += `<button class="btn-danger" style="padding: 8px 15px;" onclick="abrirJustificativaModal('${viagem.id}')">Justificar / Alterar</button>`; 
                html += `<button class="btn-primary" style="padding: 8px 15px;" onclick="mostrarDetalhesViagem('${viagem.id}')">Ver Viagem Completa</button>`; 
                html += `</div>`;

                html += `</div>`;
            });

            rel.innerHTML = html;
        }

        function gerarRelatorio() {
            const mesAno = document.getElementById('mesAno').value;
            if (!mesAno) {
                alert('Selecione o m√™s/ano.');
                return;
            }
            
            const [year, month] = mesAno.split('-').map(Number);
            const rel = document.getElementById('relatorios');
            rel.innerHTML = '';
            
            const hoursByDriver = {}; 

            viagens.forEach(v => {
                const vDate = new Date(v.data + 'T00:00:00'); 
                
                if (vDate.getFullYear() === year && vDate.getMonth() + 1 === month) {
                    
                    if (v.trechos && Array.isArray(v.trechos)) {
                        v.trechos.forEach(trecho => {
                            const driverName = trecho.motorista;
                            const nightHours = trecho.horasNoturnas || 0; 
                            
                            if (driverName) {
                                if (!hoursByDriver[driverName]) hoursByDriver[driverName] = [];
                                hoursByDriver[driverName].push({ 
                                    id: v.id, 
                                    data: v.data, 
                                    hours: trecho.horas, 
                                    nightHours: nightHours,
                                });
                            }
                        });
                    }
                }
            });
            
            if (Object.keys(hoursByDriver).length === 0) {
                rel.innerHTML = `<h3>Relat√≥rio Mensal de Horas (${month}/${year})</h3><p style="text-align: center;">Nenhuma viagem encontrada para o per√≠odo selecionado.</p>`;
                return;
            }

            for (let driver in hoursByDriver) {
                let entries = hoursByDriver[driver];
                
                const aggregatedEntries = entries.reduce((acc, entry) => {
                    const key = entry.id; 
                    if (!acc[key]) {
                        acc[key] = { 
                            id: entry.id, 
                            data: entry.data, 
                            totalHours: 0, 
                            totalNightHours: 0 
                        };
                    }
                    acc[key].totalHours += entry.hours;
                    acc[key].totalNightHours += entry.nightHours; 
                    return acc;
                }, {});

                const finalEntries = Object.values(aggregatedEntries);

                finalEntries.sort((a, b) => new Date(a.data + 'T00:00:00') - new Date(b.data + 'T00:00:00')); 
                let total = finalEntries.reduce((sum, e) => sum + e.totalHours, 0);
                let totalNight = finalEntries.reduce((sum, e) => sum + e.totalNightHours, 0); 
                
                const table = document.createElement('table');
                const caption = document.createElement('caption');
                caption.textContent = `Tabela de Horas Trabalhadas - ${driver} (${month}/${year})`;
                table.appendChild(caption);
                
                const thead = document.createElement('thead');
                const trh = document.createElement('tr');
                ['Data', 'Horas Totais (h)', 'Horas Noturnas (h)', 'A√ß√µes'].forEach(headerText => {
                    const th = document.createElement('th'); th.textContent = headerText; trh.appendChild(th);
                });
                thead.appendChild(trh);
                table.appendChild(thead);
                
                const tbody = document.createElement('tbody');
                finalEntries.forEach(e => {
                    const tr = document.createElement('tr');
                    const formattedDate = e.data.split('-').reverse().join('/');
                    
                    const td1 = document.createElement('td'); td1.textContent = formattedDate; 
                    const td2 = document.createElement('td'); td2.textContent = totalHoursToDecimal(e.totalHours);
                    const td3 = document.createElement('td'); 
                    td3.textContent = totalHoursToDecimal(e.totalNightHours);
                    td3.className = 'night-hours'; 
                    
                    const td4 = document.createElement('td');
                    const detailButton = document.createElement('button');
                    detailButton.textContent = 'Detalhes';
                    detailButton.className = 'btn-primary';
                    detailButton.style.padding = '5px 10px';
                    detailButton.setAttribute('onclick', `mostrarDetalhesViagem('${e.id}', '${driver}')`); 
                    td4.appendChild(detailButton);
                    
                    tr.appendChild(td1);
                    tr.appendChild(td2);
                    tr.appendChild(td3);
                    tr.appendChild(td4);
                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);
                
                const tfoot = document.createElement('tfoot');
                
                const trfTotal = document.createElement('tr');
                const tdf1Total = document.createElement('td'); tdf1Total.textContent = 'TOTAL GERAL';
                tdf1Total.style.fontWeight = 'bold';
                const tdf2Total = document.createElement('td'); tdf2Total.textContent = totalHoursToDecimal(total);
                tdf2Total.style.fontWeight = 'bold';
                const tdf3Total = document.createElement('td'); tdf3Total.textContent = totalHoursToDecimal(totalNight);
                tdf3Total.style.fontWeight = 'bold';
                tdf3Total.className = 'night-hours';
                const tdf4Total = document.createElement('td'); 
                
                trfTotal.appendChild(tdf1Total);
                trfTotal.appendChild(tdf2Total);
                trfTotal.appendChild(tdf3Total);
                trfTotal.appendChild(tdf4Total);
                tfoot.appendChild(trfTotal);

                table.appendChild(tfoot);
                
                rel.appendChild(table);
            }
        }

        function downloadFile(content, fileName, contentType) {
            const a = document.createElement("a");
            const file = new Blob([content], { type: contentType });
            a.href = URL.createObjectURL(file);
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(a.href);
        }

        function exportData() {
            if (viagens.length === 0 && motoristas.length === 0) {
                alert("N√£o h√° dados DEV para exportar.");
                return;
            }

            const dataToExport = {
                motoristas: motoristas,
                viagens: viagens,
                data_source: 'VIAGENS_PRO_DEV_FIREBASE' 
            };
            
            const jsonContent = JSON.stringify(dataToExport, null, 2);
            
            const date = new Date().toISOString().slice(0, 10);
            const fileName = `backup_viagens_DEV_${date}.json`;
            
            downloadFile(jsonContent, fileName, 'application/json');
            alert(`Dados DEV exportados com sucesso! Arquivo: ${fileName}`);
        }

        async function importData() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];

            if (!file) {
                alert("Por favor, selecione um arquivo JSON para importar.");
                return;
            }
            
            if (!confirm("‚ö†Ô∏è ATEN√á√ÉO: A importa√ß√£o ir√° SOBRESCREVER todos os dados DEV no Firebase. Deseja continuar com a importa√ß√£o?")) {
                return; 
            }

            const reader = new FileReader();
            
            reader.onload = async function(event) {
                try {
                    const importedData = JSON.parse(event.target.result);
                    
                    if (importedData.motoristas && Array.isArray(importedData.motoristas) && 
                        importedData.viagens && Array.isArray(importedData.viagens)) {
                        
                        motoristas = importedData.motoristas;
                        viagens = importedData.viagens;
                        
                        // Garante que a estrutura de dados esteja correta para o Firebase
                        viagens.forEach(v => {
                            if (!v.id && v.data && v.trechos && v.trechos[0]) {
                                v.id = createViagemId(v.data, v.trechos[0].inicio);
                            }
                            if (v.data) {
                                const dateObj = new Date(v.data + 'T00:00:00');
                                v.day = dateObj.toLocaleDateString('pt-BR', { weekday: 'long' }).toLowerCase();
                            }
                            if (!v.atraso) {
                                v.atraso = { isAtrasada: false, justificativa: '' };
                            }
                        });

                        await saveData(); // Salva no Firebase
                        
                        updateMotoristasList();
                        document.getElementById('relatorios').innerHTML = '<p style="text-align: center; color: #6c757d;">Dados importados para o Firebase. Gere um novo relat√≥rio para visualiza√ß√£o.</p>';
                        document.getElementById('importFileLabel').textContent = 'Nenhum arquivo escolhido';
                        document.getElementById('importFile').value = '';

                        alert(`Dados DEV importados para o Firebase com sucesso! ${viagens.length} viagens e ${motoristas.length} motoristas foram carregados.`);
                    } else {
                        throw new Error("O arquivo JSON n√£o possui a estrutura esperada (motoristas e viagens).");
                    }
                } catch (e) {
                    alert("Erro ao processar o arquivo. Verifique se √© um arquivo JSON v√°lido e com a estrutura correta. Erro: " + e.message);
                }
            };
            
            reader.onerror = function() {
                alert("Erro ao ler o arquivo.");
            };

            reader.readAsText(file);
        }

        function updateFileName() {
            const fileInput = document.getElementById('importFile');
            const fileLabel = document.getElementById('importFileLabel');
            if (fileInput.files.length > 0) {
                fileLabel.textContent = fileInput.files[0].name;
                fileLabel.style.borderColor = '#28a745';
            } else {
                fileLabel.textContent = 'Nenhum arquivo escolhido';
                fileLabel.style.borderColor = '#ced4da';
            }
        }
        
        function setupAutoFill(endId, startId) {
            const endInput = document.getElementById(endId);
            const startInput = document.getElementById(startId);
            
            if (endInput && startInput) {
                endInput.addEventListener('change', function() {
                    startInput.value = this.value;
                    if (startId === 'inicio2') { 
                         const fim2Input = document.getElementById('fim2');
                         if (fim2Input) {
                             fim2Input.dispatchEvent(new Event('change'));
                         }
                    }
                    // Atualiza o ID da Viagem em Edi√ß√£o se o in√≠cio do Trecho 1 mudar
                    if (startId === 'inicio1' && document.getElementById('viagemEmEdicaoId').value) {
                         const data = document.getElementById('dataViagem').value;
                         const novoViagemId = createViagemId(data, this.value);
                         document.getElementById('viagemEmEdicaoId').value = novoViagemId; 
                         document.getElementById('mensagemEdicao').textContent = `EDITANDO VIAGEM de ${data.split('-').reverse().join('/')} (In√≠cio Trecho 1: ${this.value}).`;
                    }
                });
            }
        }

        setupAutoFill('fim1', 'inicio2');
        setupAutoFill('fim2', 'inicio3');
        
        // --- INICIALIZA√á√ÉO ---
        loadData();
    </script>
</body>
</html>
