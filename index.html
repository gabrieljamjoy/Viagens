async function addViagem() {
            const form = document.getElementById('cadastro-viagens');
            
            // 1. Usa reportValidity() para exibir as mensagens de erro nativas do HTML.
            // Se falhar, interrompe o JS (retorna false)
            if (!form.reportValidity()) {
                return; 
            }
            
            const rota = document.getElementById('rota').value;
            const dataViagem = document.getElementById('dataViagem').value;
            
            if (!rota) return alert("Selecione a Rota.");
            if (!dataViagem) return alert("Selecione a Data da Viagem.");
            
            const trechos = [];
            
            // --- VALIDAÇÃO E MONTAGEM DO TRECHO 1 ---
            const motorista1 = document.getElementById('motorista1').value;
            const inicio1 = document.getElementById('inicio1').value;
            const fim1 = document.getElementById('fim1').value;
            
            if (!motorista1 || !inicio1 || !fim1) return alert("Preencha todos os campos do Trecho 1.");
            
            trechos.push({
                motorista: motorista1,
                inicio: inicio1,
                fim: fim1,
                label: getTrechoLabel(rota, 1),
                ...calculateHours(inicio1, fim1)
            });
            
            // --- VALIDAÇÃO E MONTAGEM DO TRECHO 2 ---
            const motorista2 = document.getElementById('motorista2').value;
            const inicio2 = document.getElementById('inicio2').value;
            const fim2 = document.getElementById('fim2').value;

            if (!motorista2 || !inicio2 || !fim2) return alert("Preencha todos os campos do Trecho 2.");

            trechos.push({
                motorista: motorista2,
                inicio: inicio2,
                fim: fim2,
                label: getTrechoLabel(rota, 2),
                ...calculateHours(inicio2, fim2)
            });

            // --- VALIDAÇÃO E MONTAGEM DO TRECHO 3 (CONDICIONAL) ---
            if (rota.includes('porto')) {
                const motorista3 = document.getElementById('motorista3').value;
                const inicio3 = document.getElementById('inicio3').value;
                const fim3 = document.getElementById('fim3').value;
                
                if (!motorista3 || !inicio3 || !fim3) {
                    return alert("A rota de Porto Seguro requer o preenchimento de todos os campos do Trecho 3.");
                }
                
                trechos.push({
                    motorista: motorista3,
                    inicio: inicio3,
                    fim: fim3,
                    label: getTrechoLabel(rota, 3),
                    ...calculateHours(inicio3, fim3)
                });
            }

            // A PARTIR DAQUI, OS DADOS ESTÃO VALIDADOS E COMPLETOS
            
            const novaViagem = {
                id: document.getElementById('viagemEmEdicaoId').value || `${dataViagem}_${trechos[0].inicio}`,
                data: dataViagem,
                rota: rota,
                trechos: trechos,
                timestamp: Date.now()
            };
            
            if (isEditing) {
                const index = viagensCadastradas.findIndex(v => v.id === novaViagem.id);
                if (index !== -1) {
                    viagensCadastradas[index] = novaViagem;
                } else {
                    console.error("Viagem em edição não encontrada.");
                    return;
                }
            } else {
                if (viagensCadastradas.some(v => v.id === novaViagem.id)) {
                    alert("Já existe uma viagem registrada com esta data e horário de início. Use a função de Edição.");
                    return;
                }
                viagensCadastradas.push(novaViagem);
            }

            if (await saveDataToFirestore()) {
                alert(isEditing ? "Viagem atualizada com sucesso!" : "Viagem salva com sucesso!");
                limparFormularioViagem(); 
            }
        }
