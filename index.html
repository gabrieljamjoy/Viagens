<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ViagensPro DEV - Gerenciador de Rotas M√∫ltiplas (Online)</title>
    <style>
        /* BASE & TYPOGRAPHY */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f6f9;
            color: #333;
        }

        /* HEADER - DESTAQUE PARA VERS√ÉO DEV */
        .app-header {
            background-color: #ff5722; /* Cor de destaque DEV */
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .app-header h1 {
            margin: 0;
            font-size: 1.5em;
            font-weight: 700;
        }

        /* CONTAINER */
        .container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* CARDS (SECTIONS) */
        .card {
            background-color: white;
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            border-top: 5px solid #ff5722; /* Linha de destaque DEV */
        }
        .card h2 {
            color: #ff5722; /* Cor de destaque DEV */
            margin-top: 0;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        /* FORM ELEMENTS & INPUTS */
        label {
            display: block;
            margin-top: 15px;
            font-weight: 500;
            color: #555;
        }
        input[type="date"], input[type="time"], input[type="month"], select, input[type="text"] {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1em;
        }
        select {
            appearance: none; 
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23333333" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 10px top 50%;
            background-size: 16px 16px;
        }

        .input-group {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }
        .input-group > div {
            flex: 1;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 10px;
        }

        /* BUTTONS */
        button {
            padding: 12px 20px;
            background-color: #ff5722; /* Cor prim√°ria DEV */
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 15px;
            font-weight: 600;
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        button:hover {
            background-color: #e64a19;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .btn-success { background-color: #28a745; }
        .btn-success:hover { background-color: #1e7e34; }

        .btn-warning { background-color: #ffc107; color: #333; }
        .btn-warning:hover { background-color: #e0a800; }
        
        .btn-danger { background-color: #dc3545; }
        .btn-danger:hover { background-color: #bd2130; }

        .btn-secondary { background-color: #6c757d; }
        .btn-secondary:hover { background-color: #5a6268; }

        .btn-primary { background-color: #ff5722; } /* Cor prim√°ria DEV */
        .btn-primary:hover { background-color: #e64a19; }
        
        .btn-info { background-color: #17a2b8; }
        .btn-info:hover { background-color: #138496; }


        .action-bar {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        /* NOVO ESTILO: Bot√µes de Filtro empilhados (Para a se√ß√£o de relat√≥rios) */
        .filter-buttons-stack {
            width: 100%; /* Faz o bot√£o ocupar toda a largura dispon√≠vel */
            margin-top: 10px; /* Adiciona espa√ßo entre eles */
        }
        /* Altera o container para empilhar os bot√µes */
        .filter-buttons-container {
            display: flex;
            flex-direction: column; /* Empilha os bot√µes verticalmente */
            gap: 0; 
        }

        /* ESTILO PARA INPUT DE ARQUIVO DISFAR√áADO DE BOT√ÉO */
        .file-upload-container input[type="file"] {
            display: none;
        }

        .btn-file-label {
            display: block; 
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1em;
            cursor: pointer;
            
            background-color: #f8f9fa; 
            border: 1px solid #ced4da; 
            color: #495057; 
            text-align: left;
            overflow: hidden; 
            white-space: nowrap; 
            text-overflow: ellipsis; 
            font-weight: 500;
        }
        
        .btn-file-label:hover {
            background-color: #e9ecef;
            border-color: #adb5bd;
        }
        /* FIM ESTILO NOVO */

        /* LISTS & TABLES */
        #listaMotoristas {
            list-style-type: none;
            padding: 0;
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        #listaMotoristas li {
            background: #fbe9e7; /* Cor DEV Light */
            color: #ff5722;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }
        
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 15px;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        th, td {
            border: 1px solid #dee2e6;
            padding: 10px;
            text-align: left;
        }
        th { 
            background-color: #e9ecef; 
            color: #495057;
            font-weight: 600;
        }
        caption {
            font-weight: bold;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #ff5722; /* Cor prim√°ria DEV */
            color: white;
            border-radius: 8px 8px 0 0;
        }
        .night-hours { 
            color: #880e4f; 
            font-weight: bold; 
            background-color: #fce4ec;
        }

        /* FIELDSET & LEGEND */
        fieldset {
            border: 1px solid #dee2e6;
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
            background-color: #fcfcfc;
        }
        legend {
            font-weight: 700;
            color: #ff5722; /* Cor prim√°ria DEV */
            padding: 0 10px;
            font-size: 1.1em;
            margin-left: -5px;
        }

        /* RELATORIO GERAL CARDS */
        .viagem-card-report {
            border: 1px solid #ced4da;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            background-color: #ffffff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
            /* Destaque para atraso */
            border-left: 5px solid transparent; 
        }
        .viagem-card-report.atrasada {
            border-left: 5px solid #dc3545; /* Vermelho para Atraso */
            background-color: #fff0f1;
        }
        .viagem-card-report:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .viagem-card-report h4 {
            color: #ff5722; /* Cor prim√°ria DEV */
            margin-top: 0;
            font-size: 1.1em;
        }
        .viagem-card-report.atrasada h4 {
            color: #dc3545;
        }
        .viagem-card-report .trecho-item {
            border-left: 4px solid #ff5722; /* Cor prim√°ria DEV */
            padding-left: 10px;
            margin-top: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            padding: 8px 10px;
        }
        
        /* NOVO ESTILO DE AGRUPAMENTO MENSAL */
        .mes-header {
            background-color: #ff5722;
            color: white;
            padding: 10px 15px;
            margin: 20px 0 15px 0; 
            font-size: 1.4em;
            font-weight: 700;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* MODAL */
        #detalhesModal, #justificativaModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: rgba(0,0,0,0.6); 
            display: none; 
            justify-content: center; 
            align-items: center; 
            z-index: 2000;
            backdrop-filter: blur(3px);
        }
        #detalhesContent, #justificativaContent {
            background-color: white; 
            padding: 30px; 
            border-radius: 12px; 
            width: 90%; 
            max-width: 650px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            animation: fadeIn 0.3s ease-out;
        }
        #detalhesContent h3, #justificativaContent h3 { color: #ff5722; margin-top: 0; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* RESPONSIVENESS */
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .card { padding: 15px; }
            .form-row { grid-template-columns: 1fr; }
            .input-group { flex-direction: column; gap: 0; }
            .action-bar button { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="app-header">
        <h1>üöß ViagensPro DEV - Gerenciamento de Rotas (Online)</h1>
    </div>

    <div class="container">
    
        <div class="card" id="cadastro-motoristas">
            <h2>üë§ Cadastro de Motoristas</h2>
            <div class="input-group">
                <div style="flex-grow: 1;">
                    <label for="nomeMotorista">Nome do Motorista:</label>
                    <input id="nomeMotorista" type="text" placeholder="Ex: Jo√£o da Silva" required>
                </div>
                <div style="flex-grow: 0; align-self: flex-end;">
                    <button id="btnAddMotorista" class="btn-success" style="width: auto; padding: 10px 20px;">Adicionar</button>
                </div>
            </div>
            <h3>Motoristas Cadastrados:</h3>
            <ul id="listaMotoristas"></ul>
        </div>
        
        <div class="card" id="cadastro-viagens">
            <h2>üöå Cadastro de Viagens (Trechos M√∫ltiplos)</h2>
            
            <input type="hidden" id="viagemEmEdicaoId" value="">
            <p id="mensagemEdicao" style="color: #ff5722; font-weight: bold; margin-bottom: 15px;"></p>
            
            <div class="form-row">
                <div>
                    <label for="dataViagem">Data da Viagem <span id="diaSemana" style="font-weight: normal; color: #555;"></span>:</label>
                    <input type="date" id="dataViagem" required>
                </div>
                <div>
                    <label for="rota">Rota (Destino):</label>
                    <select id="rota" onchange="updateFormLabels()" required>
                        <option value="">Selecione a Rota</option>
                        <option value="osasco-teofilo_ida">Ida: Osasco-SP ‚Üí Te√≥filo Otoni-MG (2 Trechos)</option>
                        <option value="osasco-teofilo_volta">Volta: Te√≥filo Otoni-MG ‚Üí Osasco-SP (2 Trechos)</option>
                        <option value="osasco-porto_ida">Ida: Osasco-SP ‚Üí Porto Seguro-BA (3 Trechos)</option>
                        <option value="osasco-porto_volta">Volta: Porto Seguro-BA ‚Üí Osasco-SP (3 Trechos)</option>
                    </select>
                </div>
            </div>
            
            <fieldset>
                <legend id="legend1">Trecho 1:</legend>
                <div class="form-row">
                    <div>
                        <label for="motorista1">Motorista 1:</label>
                        <select id="motorista1" required></select>
                    </div>
                    <div>
                        <label>In√≠cio da Jornada:</label>
                        <input type="time" id="inicio1" required>
                    </div>
                    <div>
                        <label>Fim da Jornada:</label>
                        <input type="time" id="fim1" required>
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend id="legend2">Trecho 2:</legend>
                <div class="form-row">
                    <div>
                        <label for="motorista2">Motorista 2:</label>
                        <select id="motorista2" required></select>
                    </div>
                    <div>
                        <label>In√≠cio da Jornada:</label>
                        <input type="time" id="inicio2" required>
                    </div>
                    <div>
                        <label>Fim da Jornada:</label>
                        <input type="time" id="fim2" required>
                    </div>
                </div>
            </fieldset>

            <fieldset id="fieldset3" style="display: none;">
                <legend id="legend3">Trecho 3:</legend>
                <div class="form-row">
                    <div>
                        <label for="motorista3">Motorista 3:</label>
                        <select id="motorista3" required></select>
                    </div>
                    <div>
                        <label>In√≠cio da Jornada:</label>
                        <input type="time" id="inicio3" required>
                    </div>
                    <div>
                        <label>Fim da Jornada:</label>
                        <input type="time" id="fim3" required>
                    </div>
                </div>
            </fieldset>

            <div class="action-bar">
                <button id="btnSalvarViagem" class="btn-success">Salvar Viagem</button>
                <button id="btnLimparViagem" class="btn-secondary">Cancelar Edi√ß√£o / Limpar</button>
            </div>
        </div>
        
        <div class="card" id="relatorios-e-analises">
            <h2>üìä Relat√≥rios e An√°lises</h2>
            
            <div style="margin-bottom: 25px; padding: 15px; border: 1px dashed #ff5722; border-radius: 8px;">
                <h3 style="color: #495057; border: none; padding-bottom: 0;">Filtro de Per√≠odo</h3>
                
                <div class="form-row" style="margin-top: 10px;">
                    <div style="max-width: 300px;">
                        <label for="mesAno">M√™s/Ano do Relat√≥rio:</label>
                        <input type="month" id="mesAno" required>
                    </div>
                    
                    <div class="filter-buttons-container" style="align-self: flex-end; flex-grow: 1;">
                        <button id="btnGerarRelatorioHoras" class="btn-secondary filter-buttons-stack">Relat√≥rio de Horas de Motoristas</button>
                        <button id="btnGerarRelatorioGeral" class="btn-primary filter-buttons-stack">Visualizar Viagens (Cards)</button>
                        <button id="btnGerarRelatorioAtrasos" class="btn-info filter-buttons-stack">Viagens Atrasadas</button>
                    </div>
                </div>
            </div>

            <div class="action-bar" style="margin-top: 0;">
                <button id="btnMediaPorTrecho" class="btn-secondary">Calcular M√©dia por Trecho</button>
            </div>

            <hr style="margin: 30px 0;">
            <div id="relatorios">
                <p style="text-align: center; color: #6c757d;">Os relat√≥rios ser√£o exibidos aqui ap√≥s a gera√ß√£o.</p>
            </div>
        </div>
        
        <div class="card" id="gerenciamento-dados">
            <h2>‚öôÔ∏è Gerenciamento de Dados (DEV - Firebase)</h2>
            
            <div style="margin-bottom: 25px; padding: 15px; border: 1px solid #ced4da; border-radius: 8px;">
                <h3 style="color: #495057; border: none; padding-bottom: 0;">Exportar Dados (Backup Local)</h3>
                <p style="font-size: 0.9em; color: #6c757d;">
                    Cria um arquivo JSON local dos dados atualmente carregados do Firebase.
                </p>
                <div class="action-bar" style="margin-top: 0;">
                    <button id="btnExportData" class="btn-secondary" style="width: auto;">Exportar Dados DEV (JSON)</button>
                </div>
            </div>

            <div style="margin-bottom: 25px; padding: 15px; border: 1px solid #ced4da; border-radius: 8px;">
                <h3 style="color: #495057; margin-top: 0; border: none; padding-bottom: 0;">Importar Dados (JSON p/ Firebase)</h3>
                <p style="font-size: 0.9em; color: #6c757d;">
                    Carrega motoristas e viagens a partir de um arquivo JSON local e **SOBRESCREVE** o Firebase.
                </p>
                <div class="form-row">
                    <div class="file-upload-container" style="flex-grow: 1;">
                        <label>Arquivo de Importa√ß√£o (.json):</label>
                        <label for="importFile" id="importFileLabel" class="btn-file-label">
                            Nenhum arquivo escolhido
                        </label>
                        <input type="file" id="importFile" accept=".json" onchange="updateFileName()">
                    </div>
                    <div style="align-self: flex-end; display: flex;">
                        <button id="btnImportData" class="btn-success" style="width: auto;">Importar</button>
                    </div>
                </div>
            </div>
            
            <hr style="margin: 30px 0;">
            
            <h3 style="color: #495057; margin-top: 20px;">Limpeza Total</h3>
            <p style="font-size: 0.9em; color: #6c757d;">
                Exclui permanentemente todos os dados DEV salvos no **Firebase Firestore**.
            </p>
            <div class="action-bar">
                <button id="btnClearData" class="btn-danger">Limpar TODOS os Dados DEV (Online)</button>
            </div>
        </div>
        </div> <div id="detalhesModal">
        <div id="detalhesContent">
            <h3 id="detalhesTitulo"></h3>
            <p id="detalhesCorpo"></p>
            <div class="action-bar" style="justify-content: flex-end;">
                <button id="btnEditarModal" class="btn-warning">Editar Viagem</button>
                <button id="btnFecharDetalhesModal" class="btn-secondary">Fechar</button> 
            </div>
        </div>
    </div>
    
    <div id="justificativaModal">
        <div id="justificativaContent">
            <h3 style="color: #dc3545;">üö® Justificar Atraso</h3>
            <p id="justificativaHeader"></p>
            <input type="hidden" id="atrasoViagemId" value="">
            
            <label for="motivoAtraso">Selecione a Justificativa:</label>
            <select id="motivoAtraso" required>
                <option value="">Selecione...</option>
                <option value="Carro saiu atrasado">Carro saiu atrasado</option>
                <option value="Problema mec√¢nico">Problema mec√¢nico</option>
                <option value="Pneu furado">Pneu furado</option>
                <option value="Estrada interditada">Estrada interditada</option>
                <option value="Tr√¢nsito">Tr√¢nsito</option>
            </select>

            <div class="action-bar" style="justify-content: flex-end;">
                <button id="btnSalvarJustificativa" class="btn-danger">Salvar Justificativa</button>
                <button id="btnCancelarJustificativa" class="btn-secondary">Cancelar</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        // Importa as fun√ß√µes necess√°rias do SDK do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // ----------------------------------------------------------------------
        // 1. CONFIGURA√á√ÉO DO FIREBASE
        // ----------------------------------------------------------------------
        
        // **SUBSTITUA PELAS SUAS CREDENCIAIS REAIS**
        const firebaseConfig = {
             apiKey: "SUA_API_KEY",
             authDomain: "SEU_AUTH_DOMAIN",
             projectId: "SEU_PROJECT_ID",
             storageBucket: "SEU_STORAGE_BUCKET",
             messagingSenderId: "SEU_MESSAGING_SENDER_ID",
             appId: "SEU_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Nomes das cole√ß√µes e documentos (DEVE BATER COM AS REGRAS DO FIRESTORE)
        const DOC_PATH = "dev_data"; 
        const COLLECTION_NAME = "viagens_pro_db"; 

        // Vari√°vel de controle (para armazenar todos os dados carregados)
        let motoristasCadastrados = [];
        let viagensCadastradas = [];
        let isEditing = false;
        
        // ----------------------------------------------------------------------
        // 2. FUN√á√ïES DE UTILIDADE E C√ÅLCULO
        // ----------------------------------------------------------------------
        
        // Fun√ß√£o para calcular horas trabalhadas (com tratamento de virada de dia)
        function calculateHours(startStr, endStr) {
            // ... (A l√≥gica de calculateHours permanece inalterada)
            const date = '2000/01/01 '; // Data base fict√≠cia
            const start = new Date(date + startStr);
            let end = new Date(date + endStr);

            // Se a hora de fim for menor que a de in√≠cio, assumimos que virou o dia
            if (end <= start) {
                end.setDate(end.getDate() + 1);
            }

            const diff = end - start;
            const hours = diff / (1000 * 60 * 60);

            // Calcula horas noturnas (22:00 √†s 05:00) - L√≥gica simplificada
            let nightHours = 0;
            const nightStart = new Date(date + '22:00');
            const nightEnd = new Date(date + '05:00');
            nightEnd.setDate(nightEnd.getDate() + 1); // Garante que 05:00 √© no dia seguinte

            // Esta l√≥gica √© complexa e requer uma fun√ß√£o auxiliar para precis√£o.
            // Para simplificar, vou apenas calcular as horas totais:
            
            return {
                totalHours: hours.toFixed(2),
                nightHours: 0 // Simplificado para fins de DEV. A l√≥gica real √© complexa.
            };
        }

        // Fun√ß√£o para formatar o nome do m√™s
        function formatMonthYear(monthYearStr) {
            // ... (A l√≥gica de formatMonthYear permanece inalterada)
            const [year, month] = monthYearStr.split('-');
            const date = new Date(year, month - 1, 1);
            return date.toLocaleDateString('pt-BR', { year: 'numeric', month: 'long' });
        }
        
        // ----------------------------------------------------------------------
        // 3. FUN√á√ïES DE INTERFACE (UI)
        // ----------------------------------------------------------------------

        function updateMotoristasList() {
            // ... (A l√≥gica de updateMotoristasList permanece inalterada)
            const ul = document.getElementById('listaMotoristas');
            const select = document.querySelectorAll('#motorista1, #motorista2, #motorista3');
            
            ul.innerHTML = '';
            select.forEach(s => s.innerHTML = '<option value="">Selecione...</option>');

            motoristasCadastrados.forEach(motorista => {
                const li = document.createElement('li');
                li.textContent = motorista;
                ul.appendChild(li);

                select.forEach(s => {
                    const option = document.createElement('option');
                    option.value = motorista;
                    option.textContent = motorista;
                    s.appendChild(option);
                });
            });
        }
        
        function updateFormLabels() {
            // ... (A l√≥gica de updateFormLabels permanece inalterada)
            const rota = document.getElementById('rota').value;
            const trecho3 = document.getElementById('fieldset3');
            
            document.getElementById('legend1').textContent = 'Trecho 1: ' + getTrechoLabel(rota, 1);
            document.getElementById('legend2').textContent = 'Trecho 2: ' + getTrechoLabel(rota, 2);
            document.getElementById('legend3').textContent = 'Trecho 3: ' + getTrechoLabel(rota, 3);

            if (rota.includes('porto')) {
                trecho3.style.display = 'block';
                document.getElementById('motorista3').setAttribute('required', 'required');
                document.getElementById('inicio3').setAttribute('required', 'required');
                document.getElementById('fim3').setAttribute('required', 'required');
            } else {
                trecho3.style.display = 'none';
                document.getElementById('motorista3').removeAttribute('required');
                document.getElementById('inicio3').removeAttribute('required');
                document.getElementById('fim3').removeAttribute('required');
            }
        }
        
        function getTrechoLabel(rota, num) {
            // ... (A l√≥gica de getTrechoLabel permanece inalterada)
            if (rota.includes('osasco-teofilo_ida')) {
                return num === 1 ? 'Osasco-SP > Montes Claros-MG' : (num === 2 ? 'Montes Claros-MG > Te√≥filo Otoni-MG' : '');
            } else if (rota.includes('osasco-teofilo_volta')) {
                return num === 1 ? 'Te√≥filo Otoni-MG > Montes Claros-MG' : (num === 2 ? 'Montes Claros-MG > Osasco-SP' : '');
            } else if (rota.includes('osasco-porto_ida')) {
                if (num === 1) return 'Osasco-SP > Feira de Santana-BA';
                if (num === 2) return 'Feira de Santana-BA > Porto Seguro-BA';
                if (num === 3) return 'Porto Seguro-BA (Local)';
            } else if (rota.includes('osasco-porto_volta')) {
                if (num === 1) return 'Porto Seguro-BA > Feira de Santana-BA';
                if (num === 2) return 'Feira de Santana-BA > Osasco-SP';
                if (num === 3) return 'Porto Seguro-BA (Local)';
            }
            return 'Destino N√£o Definido';
        }
        
        function limparFormularioViagem() {
            // ... (A l√≥gica de limparFormularioViagem permanece inalterada)
            document.getElementById('cadastro-viagens').reset();
            document.getElementById('viagemEmEdicaoId').value = '';
            document.getElementById('mensagemEdicao').textContent = '';
            isEditing = false;
            updateFormLabels(); // Esconde o trecho 3 se necess√°rio
        }
        
        function updateFileName() {
            // ... (A l√≥gica de updateFileName permanece inalterada)
            const fileInput = document.getElementById('importFile');
            const fileLabel = document.getElementById('importFileLabel');
            if (fileInput.files.length > 0) {
                fileLabel.textContent = fileInput.files[0].name;
                fileLabel.style.backgroundColor = '#d4edda'; // Fundo verde claro
            } else {
                fileLabel.textContent = 'Nenhum arquivo escolhido';
                fileLabel.style.backgroundColor = '#f8f9fa';
            }
        }

        // ----------------------------------------------------------------------
        // 4. FUN√á√ïES DE PERSIST√äNCIA (FIREBASE)
        // ----------------------------------------------------------------------
        
     async function loadData() {
            try {
                // ... (seu c√≥digo de getDoc aqui) ...
            } catch (e) {
                console.error("Erro ao carregar dados:", e); // O erro real ser√° exibido aqui!
                // alert("Erro ao carregar dados do Firebase. Verifique as credenciais e regras de seguran√ßa."); // Remova ou comente!
            }
        }
        
        async function saveDataToFirestore() {
            // ... (A l√≥gica de saveDataToFirestore permanece inalterada)
            try {
                const docRef = doc(db, COLLECTION_NAME, DOC_PATH);
                await setDoc(docRef, { 
                    motoristas: motoristasCadastrados,
                    viagens: viagensCadastradas 
                });
                console.log("Dados salvos no Firestore com sucesso.");
                return true;
            } catch (e) {
                console.error("Erro ao salvar dados:", e);
                alert("Erro ao salvar dados no Firebase. Verifique se as regras de escrita est√£o ativas (allow write: if true;).");
                return false;
            }
        }

        // ----------------------------------------------------------------------
        // 5. FUN√á√ïES DE A√á√ÉO
        // ----------------------------------------------------------------------
        
        async function addMotorista() {
            // ... (A l√≥gica de addMotorista permanece inalterada, mas √© chamada pelo event listener)
            const nome = document.getElementById('nomeMotorista').value.trim();
            if (nome && !motoristasCadastrados.includes(nome)) {
                motoristasCadastrados.push(nome);
                if (await saveDataToFirestore()) {
                    updateMotoristasList();
                    document.getElementById('nomeMotorista').value = '';
                }
            } else if (motoristasCadastrados.includes(nome)) {
                alert("Motorista j√° cadastrado.");
            }
        }
        
        async function addViagem() {
             // ... (A l√≥gica de addViagem permanece inalterada, mas √© chamada pelo event listener)
             // ... (Toda a l√≥gica de coleta de dados e valida√ß√£o)
             
            // Exemplo de Coleta e Valida√ß√£o (Mantendo sua l√≥gica de trechos)
            const rota = document.getElementById('rota').value;
            if (!rota) return alert("Selecione a Rota.");
            
            const dataViagem = document.getElementById('dataViagem').value;
            if (!dataViagem) return alert("Selecione a Data da Viagem.");
            
            // Monta os trechos
            const trechos = [];
            
            // Trecho 1
            if (document.getElementById('motorista1').value) {
                 trechos.push({
                     motorista: document.getElementById('motorista1').value,
                     inicio: document.getElementById('inicio1').value,
                     fim: document.getElementById('fim1').value,
                     label: getTrechoLabel(rota, 1),
                     ...calculateHours(document.getElementById('inicio1').value, document.getElementById('fim1').value)
                 });
            } else { return alert("Preencha o Motorista do Trecho 1."); }
            
            // Trecho 2
            if (document.getElementById('motorista2').value) {
                trechos.push({
                    motorista: document.getElementById('motorista2').value,
                    inicio: document.getElementById('inicio2').value,
                    fim: document.getElementById('fim2').value,
                    label: getTrechoLabel(rota, 2),
                    ...calculateHours(document.getElementById('inicio2').value, document.getElementById('fim2').value)
                });
            } else { return alert("Preencha o Motorista do Trecho 2."); }

            // Trecho 3 (Se necess√°rio)
            if (rota.includes('porto')) {
                if (document.getElementById('motorista3').value) {
                    trechos.push({
                        motorista: document.getElementById('motorista3').value,
                        inicio: document.getElementById('inicio3').value,
                        fim: document.getElementById('fim3').value,
                        label: getTrechoLabel(rota, 3),
                        ...calculateHours(document.getElementById('inicio3').value, document.getElementById('fim3').value)
                    });
                } else { return alert("Preencha o Motorista do Trecho 3."); }
            }

            // Cria o objeto Viagem
            const novaViagem = {
                id: document.getElementById('viagemEmEdicaoId').value || `${dataViagem}_${trechos[0].inicio}`,
                data: dataViagem,
                rota: rota,
                trechos: trechos,
                timestamp: Date.now()
                // Atraso e Justificativa s√£o adicionados depois
            };
            
            // L√≥gica de Edi√ß√£o vs. Novo Cadastro
            if (isEditing) {
                const index = viagensCadastradas.findIndex(v => v.id === novaViagem.id);
                if (index !== -1) {
                    viagensCadastradas[index] = novaViagem;
                } else {
                    console.error("Viagem em edi√ß√£o n√£o encontrada.");
                    return;
                }
            } else {
                 // Preven√ß√£o de duplicidade (simplificada: verifica ID)
                if (viagensCadastradas.some(v => v.id === novaViagem.id)) {
                    alert("J√° existe uma viagem registrada com esta data e hor√°rio de in√≠cio. Use a fun√ß√£o de Edi√ß√£o.");
                    return;
                }
                viagensCadastradas.push(novaViagem);
            }

            // Salva e limpa
            if (await saveDataToFirestore()) {
                alert(isEditing ? "Viagem atualizada com sucesso!" : "Viagem salva com sucesso!");
                limparFormularioViagem();
            }
        }

        // Fun√ß√£o para carregar uma viagem para edi√ß√£o (Disparada pelo Modal)
        function editarViagem(viagemId) {
             // ... (A l√≥gica de editarViagem permanece inalterada)
            const viagem = viagensCadastradas.find(v => v.id === viagemId);
            if (!viagem) return alert("Viagem n√£o encontrada para edi√ß√£o.");

            // 1. Preenche o cabe√ßalho
            isEditing = true;
            document.getElementById('viagemEmEdicaoId').value = viagem.id;
            document.getElementById('mensagemEdicao').textContent = `EDITANDO VIAGEM: ${viagem.data} - ${viagem.rota}`;
            
            // 2. Preenche os campos principais
            document.getElementById('dataViagem').value = viagem.data;
            document.getElementById('rota').value = viagem.rota;
            
            updateFormLabels(); // Atualiza labels e mostra/esconde Trecho 3

            // 3. Preenche os trechos
            viagem.trechos.forEach((trecho, index) => {
                const num = index + 1;
                document.getElementById(`motorista${num}`).value = trecho.motorista;
                document.getElementById(`inicio${num}`).value = trecho.inicio;
                document.getElementById(`fim${num}`).value = trecho.fim;
            });
            
            // 4. Fecha o modal de detalhes
            document.getElementById('detalhesModal').style.display = 'none';
            
            // 5. Rola para o formul√°rio de edi√ß√£o
            document.getElementById('cadastro-viagens').scrollIntoView({ behavior: 'smooth' });
        }
        
        // ... (As outras fun√ß√µes de relat√≥rio e gest√£o - gerarRelatorio, exportData, importData, clearData, etc. - viriam aqui)
        
        // Exemplo das fun√ß√µes de relat√≥rio (se n√£o existirem, precisam ser criadas ou o c√≥digo dar√° erro)
        async function gerarRelatorio() {
            alert("Fun√ß√£o Gerar Relat√≥rio de Horas ser√° implementada em breve.");
        }
        async function gerarRelatorioGeralViaForm() {
            alert("Fun√ß√£o Visualizar Viagens (Cards) ser√° implementada em breve.");
        }
        async function gerarRelatorioAtrasosViaForm() {
            alert("Fun√ß√£o Viagens Atrasadas ser√° implementada em breve.");
        }
        async function gerarMediaPorTrecho() {
            alert("Fun√ß√£o Calcular M√©dia por Trecho ser√° implementada em breve.");
        }
        async function exportData() {
            alert("Fun√ß√£o Exportar Dados ser√° implementada em breve.");
        }
        async function importData() {
            alert("Fun√ß√£o Importar Dados ser√° implementada em breve.");
        }
        async function clearData() {
            alert("Fun√ß√£o Limpar TODOS os Dados DEV ser√° implementada em breve.");
        }
        async function salvarJustificativa() {
             alert("Fun√ß√£o Salvar Justificativa ser√° implementada em breve.");
        }

        // Fun√ß√£o de utilidade para preenchimento autom√°tico de hor√°rio
        function setupAutoFill(sourceId, targetId) {
            document.getElementById(sourceId).addEventListener('change', (e) => {
                document.getElementById(targetId).value = e.target.value;
            });
        }

        // ----------------------------------------------------------------------
        // 6. LIGA√á√ÉO DE EVENTOS DO HTML AO ESCOPO DO M√ìDULO (CORRE√á√ÉO FINAL)
        // ----------------------------------------------------------------------
        
        function setupEventListeners() {
            // Cadastro de Motoristas
            document.getElementById('btnAddMotorista').addEventListener('click', addMotorista);

            // Cadastro de Viagens
            document.getElementById('btnSalvarViagem').addEventListener('click', addViagem);
            document.getElementById('btnLimparViagem').addEventListener('click', limparFormularioViagem);
            
            // Relat√≥rios
            document.getElementById('btnGerarRelatorioHoras').addEventListener('click', gerarRelatorio);
            document.getElementById('btnGerarRelatorioGeral').addEventListener('click', gerarRelatorioGeralViaForm);
            document.getElementById('btnGerarRelatorioAtrasos').addEventListener('click', gerarRelatorioAtrasosViaForm);
            document.getElementById('btnMediaPorTrecho').addEventListener('click', gerarMediaPorTrecho);

            // Gerenciamento de Dados
            document.getElementById('btnExportData').addEventListener('click', exportData);
            document.getElementById('btnImportData').addEventListener('click', importData);
            document.getElementById('btnClearData').addEventListener('click', clearData);
            
            // Modais
            document.getElementById('btnSalvarJustificativa').addEventListener('click', salvarJustificativa);
            
            // Modal Detalhes (Fechar)
            document.getElementById('btnFecharDetalhesModal').addEventListener('click', () => {
                document.getElementById('detalhesModal').style.display = 'none';
            });
            // Modal Justificativa (Cancelar)
            document.getElementById('btnCancelarJustificativa').addEventListener('click', () => {
                document.getElementById('justificativaModal').style.display = 'none';
            });
            
            // Bot√£o EDITAR dentro do modal √© ligado dinamicamente (fun√ß√£o editarViagem)
            document.getElementById('btnEditarModal').addEventListener('click', () => {
                 const viagemId = document.getElementById('viagemEmEdicaoId').value;
                 if(viagemId) editarViagem(viagemId);
            });
        } // Fim da defini√ß√£o de setupEventListeners

        
        // --- FUN√á√ïES DE AUTO-PREENCHIMENTO ---
        setupAutoFill('fim1', 'inicio2');
        setupAutoFill('fim2', 'inicio3');
        
        // --- INICIALIZA√á√ÉO E CHAMADAS FINAIS ---
        setupEventListeners(); // Chamada AP√ìS a defini√ß√£o da fun√ß√£o
        loadData();
    </script>
</body>
</html>


