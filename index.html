<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ViagensPro DEV - Gerenciador de Rotas M√∫ltiplas (Online)</title>
    <style>
        /* BASE & TYPOGRAPHY */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f6f9;
            color: #333;
        }

        /* HEADER - DESTAQUE PARA VERS√ÉO DEV */
        .app-header {
            background-color: #ff5722; /* Cor de destaque DEV */
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .app-header h1 {
            margin: 0;
            font-size: 1.5em;
            font-weight: 700;
        }

        /* CONTAINER */
        .container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* CARDS (SECTIONS) */
        .card {
            background-color: white;
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            border-top: 5px solid #ff5722; /* Linha de destaque DEV */
        }
        .card h2 {
            color: #ff5722; /* Cor de destaque DEV */
            margin-top: 0;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        /* FORM ELEMENTS & INPUTS */
        label {
            display: block;
            margin-top: 15px;
            font-weight: 500;
            color: #555;
        }
        input[type="date"], input[type="time"], input[type="month"], select, input[type="text"] {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1em;
        }
        select {
            appearance: none; 
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23333333" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 10px top 50%;
            background-size: 16px 16px;
        }

        .input-group {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }
        .input-group > div {
            flex: 1;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 10px;
        }

        /* BUTTONS */
        button {
            padding: 12px 20px;
            background-color: #ff5722; /* Cor prim√°ria DEV */
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 15px;
            font-weight: 600;
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        button:hover {
            background-color: #e64a19;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .btn-success { background-color: #28a745; }
        .btn-success:hover { background-color: #1e7e34; }

        .btn-warning { background-color: #ffc107; color: #333; }
        .btn-warning:hover { background-color: #e0a800; }
        
        .btn-danger { background-color: #dc3545; }
        .btn-danger:hover { background-color: #bd2130; }

        .btn-secondary { background-color: #6c757d; }
        .btn-secondary:hover { background-color: #5a6268; }

        .btn-primary { background-color: #ff5722; } /* Cor prim√°ria DEV */
        .btn-primary:hover { background-color: #e64a19; }
        
        .btn-info { background-color: #17a2b8; }
        .btn-info:hover { background-color: #138496; }


        .action-bar {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        /* NOVO ESTILO: Bot√µes de Filtro empilhados (Para a se√ß√£o de relat√≥rios) */
        .filter-buttons-stack {
            width: 100%; /* Faz o bot√£o ocupar toda a largura dispon√≠vel */
            margin-top: 10px; /* Adiciona espa√ßo entre eles */
        }
        /* Altera o container para empilhar os bot√µes */
        .filter-buttons-container {
            display: flex;
            flex-direction: column; /* Empilha os bot√µes verticalmente */
            gap: 0; 
        }

        /* ESTILO PARA INPUT DE ARQUIVO DISFAR√áADO DE BOT√ÉO */
        .file-upload-container input[type="file"] {
            display: none;
        }

        .btn-file-label {
            display: block; 
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1em;
            cursor: pointer;
            
            background-color: #f8f9fa; 
            border: 1px solid #ced4da; 
            color: #495057; 
            text-align: left;
            overflow: hidden; 
            white-space: nowrap; 
            text-overflow: ellipsis; 
            font-weight: 500;
        }
        
        .btn-file-label:hover {
            background-color: #e9ecef;
            border-color: #adb5bd;
        }
        /* FIM ESTILO NOVO */

        /* LISTS & TABLES */
        #listaMotoristas {
            list-style-type: none;
            padding: 0;
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        #listaMotoristas li {
            background: #fbe9e7; /* Cor DEV Light */
            color: #ff5722;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }
        
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 15px;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        th, td {
            border: 1px solid #dee2e6;
            padding: 10px;
            text-align: left;
        }
        th { 
            background-color: #e9ecef; 
            color: #495057;
            font-weight: 600;
        }
        caption {
            font-weight: bold;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #ff5722; /* Cor prim√°ria DEV */
            color: white;
            border-radius: 8px 8px 0 0;
        }
        .night-hours { 
            color: #880e4f; 
            font-weight: bold; 
            background-color: #fce4ec;
        }

        /* FIELDSET & LEGEND */
        fieldset {
            border: 1px solid #dee2e6;
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
            background-color: #fcfcfc;
        }
        legend {
            font-weight: 700;
            color: #ff5722; /* Cor prim√°ria DEV */
            padding: 0 10px;
            font-size: 1.1em;
            margin-left: -5px;
        }

        /* RELATORIO GERAL CARDS */
        .viagem-card-report {
            border: 1px solid #ced4da;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            background-color: #ffffff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
            /* Destaque para atraso */
            border-left: 5px solid transparent; 
        }
        .viagem-card-report.atrasada {
            border-left: 5px solid #dc3545; /* Vermelho para Atraso */
            background-color: #fff0f1;
        }
        .viagem-card-report:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .viagem-card-report h4 {
            color: #ff5722; /* Cor prim√°ria DEV */
            margin-top: 0;
            font-size: 1.1em;
        }
        .viagem-card-report.atrasada h4 {
            color: #dc3545;
        }
        .viagem-card-report .trecho-item {
            border-left: 4px solid #ff5722; /* Cor prim√°ria DEV */
            padding-left: 10px;
            margin-top: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            padding: 8px 10px;
        }
        
        /* NOVO ESTILO DE AGRUPAMENTO MENSAL */
        .mes-header {
            background-color: #ff5722;
            color: white;
            padding: 10px 15px;
            margin: 20px 0 15px 0; 
            font-size: 1.4em;
            font-weight: 700;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* MODAL */
        #detalhesModal, #justificativaModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: rgba(0,0,0,0.6); 
            display: none; 
            justify-content: center; 
            align-items: center; 
            z-index: 2000;
            backdrop-filter: blur(3px);
        }
        #detalhesContent, #justificativaContent {
            background-color: white; 
            padding: 30px; 
            border-radius: 12px; 
            width: 90%; 
            max-width: 650px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            animation: fadeIn 0.3s ease-out;
        }
        #detalhesContent h3, #justificativaContent h3 { color: #ff5722; margin-top: 0; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* RESPONSIVENESS */
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .card { padding: 15px; }
            .form-row { grid-template-columns: 1fr; }
            .input-group { flex-direction: column; gap: 0; }
            .action-bar button { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="app-header">
        <h1>üöß ViagensPro DEV - Gerenciamento de Rotas (Online)</h1>
    </div>

    <div class="container">
    
        <div class="card" id="cadastro-motoristas">
            <h2>üë§ Cadastro de Motoristas</h2>
            <div class="input-group">
                <div style="flex-grow: 1;">
                    <label for="nomeMotorista">Nome do Motorista:</label>
                    <input id="nomeMotorista" type="text" placeholder="Ex: Jo√£o da Silva" required>
                </div>
                <div style="flex-grow: 0; align-self: flex-end;">
                    <button id="btnAddMotorista" class="btn-success" style="width: auto; padding: 10px 20px;">Adicionar</button>
                </div>
            </div>
            <h3>Motoristas Cadastrados:</h3>
            <ul id="listaMotoristas"></ul>
        </div>
        
        <div class="card" id="cadastro-viagens">
            <h2>üöå Cadastro de Viagens (Trechos M√∫ltiplos)</h2>
            
            <input type="hidden" id="viagemEmEdicaoId" value="">
            <p id="mensagemEdicao" style="color: #ff5722; font-weight: bold; margin-bottom: 15px;"></p>
            
            <div class="form-row">
                <div>
                    <label for="dataViagem">Data da Viagem <span id="diaSemana" style="font-weight: normal; color: #555;"></span>:</label>
                    <input type="date" id="dataViagem" required>
                </div>
                <div>
                    <label for="rota">Rota (Destino):</label>
                    <select id="rota" onchange="updateFormLabels()" required>
                        <option value="">Selecione a Rota</option>
                        <option value="osasco-teofilo_ida">Ida: Osasco-SP ‚Üí Te√≥filo Otoni-MG (2 Trechos)</option>
                        <option value="osasco-teofilo_volta">Volta: Te√≥filo Otoni-MG ‚Üí Osasco-SP (2 Trechos)</option>
                        <option value="osasco-porto_ida">Ida: Osasco-SP ‚Üí Porto Seguro-BA (3 Trechos)</option>
                        <option value="osasco-porto_volta">Volta: Porto Seguro-BA ‚Üí Osasco-SP (3 Trechos)</option>
                    </select>
                </div>
            </div>
            
            <fieldset>
                <legend id="legend1">Trecho 1:</legend>
                <div class="form-row">
                    <div>
                        <label for="motorista1">Motorista 1:</label>
                        <select id="motorista1" required></select>
                    </div>
                    <div>
                        <label>In√≠cio da Jornada:</label>
                        <input type="time" id="inicio1" required>
                    </div>
                    <div>
                        <label>Fim da Jornada:</label>
                        <input type="time" id="fim1" required>
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend id="legend2">Trecho 2:</legend>
                <div class="form-row">
                    <div>
                        <label for="motorista2">Motorista 2:</label>
                        <select id="motorista2" required></select>
                    </div>
                    <div>
                        <label>In√≠cio da Jornada:</label>
                        <input type="time" id="inicio2" required>
                    </div>
                    <div>
                        <label>Fim da Jornada:</label>
                        <input type="time" id="fim2" required>
                    </div>
                </div>
            </fieldset>

            <fieldset id="fieldset3" style="display: none;">
                <legend id="legend3">Trecho 3:</legend>
                <div class="form-row">
                    <div>
                        <label for="motorista3">Motorista 3:</label>
                        <select id="motorista3" required></select>
                    </div>
                    <div>
                        <label>In√≠cio da Jornada:</label>
                        <input type="time" id="inicio3" required>
                    </div>
                    <div>
                        <label>Fim da Jornada:</label>
                        <input type="time" id="fim3" required>
                    </div>
                </div>
            </fieldset>

            <div class="action-bar">
                <button id="btnSalvarViagem" class="btn-success">Salvar Viagem</button>
                <button id="btnLimparViagem" class="btn-secondary">Cancelar Edi√ß√£o / Limpar</button>
            </div>
        </div>
        
        <div class="card" id="relatorios-e-analises">
            <h2>üìä Relat√≥rios e An√°lises</h2>
            
            <div style="margin-bottom: 25px; padding: 15px; border: 1px dashed #ff5722; border-radius: 8px;">
                <h3 style="color: #495057; border: none; padding-bottom: 0;">Filtro de Per√≠odo</h3>
                
                <div class="form-row" style="margin-top: 10px;">
                    <div style="max-width: 300px;">
                        <label for="mesAno">M√™s/Ano do Relat√≥rio:</label>
                        <input type="month" id="mesAno" required>
                    </div>
                    
                    <div class="filter-buttons-container" style="align-self: flex-end; flex-grow: 1;">
                        <button id="btnGerarRelatorioHoras" class="btn-secondary filter-buttons-stack">Relat√≥rio de Horas de Motoristas</button>
                        <button id="btnGerarRelatorioGeral" class="btn-primary filter-buttons-stack">Visualizar Viagens (Cards)</button>
                        <button id="btnGerarRelatorioAtrasos" class="btn-info filter-buttons-stack">Viagens Atrasadas</button>
                    </div>
                </div>
            </div>

            <div class="action-bar" style="margin-top: 0;">
                <button id="btnMediaPorTrecho" class="btn-secondary">Calcular M√©dia por Trecho</button>
            </div>

            <hr style="margin: 30px 0;">
            <div id="relatorios">
                <p style="text-align: center; color: #6c757d;">Os relat√≥rios ser√£o exibidos aqui ap√≥s a gera√ß√£o.</p>
            </div>
        </div>
        
        <div class="card" id="gerenciamento-dados">
            <h2>‚öôÔ∏è Gerenciamento de Dados (DEV - Firebase)</h2>
            
            <div style="margin-bottom: 25px; padding: 15px; border: 1px solid #ced4da; border-radius: 8px;">
                <h3 style="color: #495057; border: none; padding-bottom: 0;">Exportar Dados (Backup Local)</h3>
                <p style="font-size: 0.9em; color: #6c757d;">
                    Cria um arquivo JSON local dos dados atualmente carregados do Firebase.
                </p>
                <div class="action-bar" style="margin-top: 0;">
                    <button id="btnExportData" class="btn-secondary" style="width: auto;">Exportar Dados DEV (JSON)</button>
                </div>
            </div>

            <div style="margin-bottom: 25px; padding: 15px; border: 1px solid #ced4da; border-radius: 8px;">
                <h3 style="color: #495057; margin-top: 0; border: none; padding-bottom: 0;">Importar Dados (JSON p/ Firebase)</h3>
                <p style="font-size: 0.9em; color: #6c757d;">
                    Carrega motoristas e viagens a partir de um arquivo JSON local e **SOBRESCREVE** o Firebase.
                </p>
                <div class="form-row">
                    <div class="file-upload-container" style="flex-grow: 1;">
                        <label>Arquivo de Importa√ß√£o (.json):</label>
                        <label for="importFile" id="importFileLabel" class="btn-file-label">
                            Nenhum arquivo escolhido
                        </label>
                        <input type="file" id="importFile" accept=".json" onchange="updateFileName()">
                    </div>
                    <div style="align-self: flex-end; display: flex;">
                        <button id="btnImportData" class="btn-success" style="width: auto;">Importar</button>
                    </div>
                </div>
            </div>
            
            <hr style="margin: 30px 0;">
            
            <h3 style="color: #495057; margin-top: 20px;">Limpeza Total</h3>
            <p style="font-size: 0.9em; color: #6c757d;">
                Exclui permanentemente todos os dados DEV salvos no **Firebase Firestore**.
            </p>
            <div class="action-bar">
                <button id="btnClearData" class="btn-danger">Limpar TODOS os Dados DEV (Online)</button>
            </div>
        </div>
        </div> <div id="detalhesModal">
        <div id="detalhesContent">
            <h3 id="detalhesTitulo"></h3>
            <p id="detalhesCorpo"></p>
            <div class="action-bar" style="justify-content: flex-end;">
                <button id="btnEditarModal" class="btn-warning">Editar Viagem</button>
                <button id="btnFecharDetalhesModal" class="btn-secondary">Fechar</button> 
            </div>
        </div>
    </div>
    
    <div id="justificativaModal">
        <div id="justificativaContent">
            <h3 style="color: #dc3545;">üö® Justificar Atraso</h3>
            <p id="justificativaHeader"></p>
            <input type="hidden" id="atrasoViagemId" value="">
            
            <label for="motivoAtraso">Selecione a Justificativa:</label>
            <select id="motivoAtraso" required>
                <option value="">Selecione...</option>
                <option value="Carro saiu atrasado">Carro saiu atrasado</option>
                <option value="Problema mec√¢nico">Problema mec√¢nico</option>
                <option value="Pneu furado">Pneu furado</option>
                <option value="Estrada interditada">Estrada interditada</option>
                <option value="Tr√¢nsito">Tr√¢nsito</option>
            </select>

            <div class="action-bar" style="justify-content: flex-end;">
                <button id="btnSalvarJustificativa" class="btn-danger">Salvar Justificativa</button>
                <button id="btnCancelarJustificativa" class="btn-secondary">Cancelar</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        // Importa as fun√ß√µes necess√°rias do SDK do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // ----------------------------------------------------------------------
        // 1. CONFIGURA√á√ÉO DO FIREBASE (INSERIDO COM SEUS DADOS)
        // ----------------------------------------------------------------------
        
        const firebaseConfig = {
             apiKey: "AIzaSyCKKVtLUKRwhMvdsQInr4saBM08PO1PZ2k",
             authDomain: "cadastro-de-viagens.firebaseapp.com",
             projectId: "cadastro-de-viagens",
             storageBucket: "cadastro-de-viagens.firebasestorage.app",
             messagingSenderId: "366307042816",
             appId: "1:366307042816:web:93bb38413a0e5e26689ae5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Nomes das cole√ß√µes e documentos 
        const DOC_PATH = "dev_data"; 
        const COLLECTION_NAME = "viagens_pro_db"; 

        // Vari√°vel de controle (para armazenar todos os dados carregados)
        let motoristasCadastrados = [];
        let viagensCadastradas = [];
        let isEditing = false;
        
        // ----------------------------------------------------------------------
        // 2. FUN√á√ïES DE UTILIDADE E C√ÅLCULO
        // ----------------------------------------------------------------------
        
        function calculateHours(startStr, endStr) {
            const date = '2000/01/01 '; // Data base fict√≠cia
            const start = new Date(date + startStr);
            let end = new Date(date + endStr);

            if (end <= start) {
                end.setDate(end.getDate() + 1);
            }

            const diff = end - start;
            const hours = diff / (1000 * 60 * 60);
            
            return {
                totalHours: hours.toFixed(2),
                nightHours: 0 
            };
        }

        function formatMonthYear(monthYearStr) {
            const [year, month] = monthYearStr.split('-');
            const date = new Date(year, month - 1, 1);
            return date.toLocaleDateString('pt-BR', { year: 'numeric', month: 'long' });
        }
        
        // ----------------------------------------------------------------------
        // 3. FUN√á√ïES DE INTERFACE (UI)
        // ----------------------------------------------------------------------

        function updateMotoristasList() {
            const ul = document.getElementById('listaMotoristas');
            const select = document.querySelectorAll('#motorista1, #motorista2, #motorista3');
            
            ul.innerHTML = '';
            select.forEach(s => s.innerHTML = '<option value="">Selecione...</option>');

            motoristasCadastrados.forEach(motorista => {
                const li = document.createElement('li');
                li.textContent = motorista;
                ul.appendChild(li);

                select.forEach(s => {
                    const option = document.createElement('option');
                    option.value = motorista;
                    option.textContent = motorista;
                    s.appendChild(option);
                });
            });
        }
        
        function updateFormLabels() {
            const rota = document.getElementById('rota').value;
            const trecho3 = document.getElementById('fieldset3');
            
            document.getElementById('legend1').textContent = 'Trecho 1: ' + getTrechoLabel(rota, 1);
            document.getElementById('legend2').textContent = 'Trecho 2: ' + getTrechoLabel(rota, 2);
            document.getElementById('legend3').textContent = 'Trecho 3: ' + getTrechoLabel(rota, 3);

            if (rota.includes('porto')) {
                trecho3.style.display = 'block';
                document.getElementById('motorista3').setAttribute('required', 'required');
                document.getElementById('inicio3').setAttribute('required', 'required');
                document.getElementById('fim3').setAttribute('required', 'required');
            } else {
                trecho3.style.display = 'none';
                document.getElementById('motorista3').removeAttribute('required');
                document.getElementById('inicio3').removeAttribute('required');
                document.getElementById('fim3').removeAttribute('required');
            }
        }
        
        function getTrechoLabel(rota, num) {
            if (rota.includes('osasco-teofilo_ida')) {
                return num === 1 ? 'Osasco-SP > Montes Claros-MG' : (num === 2 ? 'Montes Claros-MG > Te√≥filo Otoni-MG' : '');
            } else if (rota.includes('osasco-teofilo_volta')) {
                return num === 1 ? 'Te√≥filo Otoni-MG > Montes Claros-MG' : (num === 2 ? 'Montes Claros-MG > Osasco-SP' : '');
            } else if (rota.includes('osasco-porto_ida')) {
                if (num === 1) return 'Osasco-SP > Feira de Santana-BA';
                if (num === 2) return 'Feira de Santana-BA > Porto Seguro-BA';
                if (num === 3) return 'Porto Seguro-BA (Local)';
            } else if (rota.includes('osasco-porto_volta')) {
                if (num === 1) return 'Porto Seguro-BA > Feira de Santana-BA';
                if (num === 2) return 'Feira de Santana-BA > Osasco-SP';
                if (num === 3) return 'Porto Seguro-BA (Local)';
            }
            return 'Destino N√£o Definido';
        }
        
        function limparFormularioViagem() {
            document.getElementById('cadastro-viagens').reset();
            document.getElementById('viagemEmEdicaoId').value = '';
            document.getElementById('mensagemEdicao').textContent = '';
            isEditing = false;
            updateFormLabels(); 
        }
        
        function updateFileName() {
            const fileInput = document.getElementById('importFile');
            const fileLabel = document.getElementById('importFileLabel');
            if (fileInput.files.length > 0) {
                fileLabel.textContent = fileInput.files[0].name;
                fileLabel.style.backgroundColor = '#d4edda'; 
            } else {
                fileLabel.textContent = 'Nenhum arquivo escolhido';
                fileLabel.style.backgroundColor = '#f8f9fa';
            }
        }

        // ----------------------------------------------------------------------
        // 4. FUN√á√ïES DE PERSIST√äNCIA (FIREBASE)
        // ----------------------------------------------------------------------
        
        async function loadData() {
            try {
                const docRef = doc(db, COLLECTION_NAME, DOC_PATH);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    motoristasCadastrados = data.motoristas || [];
                    viagensCadastradas = data.viagens || [];
                } else {
                    // Cria o documento inicial se ele n√£o existir
                    console.log("Documento n√£o encontrado. Criando estrutura inicial.");
                    await setDoc(docRef, { motoristas: [], viagens: [] });
                    motoristasCadastrados = [];
                    viagensCadastradas = [];
                }
                // ESSA CHAMADA GARANTE QUE A LISTA SEJA ATUALIZADA AP√ìS O CARREGAMENTO
                updateMotoristasList(); 
            } catch (e) {
                console.error("Erro ao carregar dados:", e);
                // Mantemos o alerta caso o usu√°rio tenha um erro de API/Credenciais
                // alert("Erro ao carregar dados do Firebase. Verifique as credenciais e regras de seguran√ßa."); 
            }
        }
        
        async function saveDataToFirestore() {
            try {
                const docRef = doc(db, COLLECTION_NAME, DOC_PATH);
                await setDoc(docRef, { 
                    motoristas: motoristasCadastrados,
                    viagens: viagensCadastradas 
                });
                console.log("Dados salvos no Firestore com sucesso.");
                return true;
            } catch (e) {
                console.error("Erro ao salvar dados:", e);
                alert("Erro ao salvar dados no Firebase. Verifique se as regras de escrita est√£o ativas.");
                return false;
            }
        }

        // ----------------------------------------------------------------------
        // 5. FUN√á√ïES DE A√á√ÉO
        // ----------------------------------------------------------------------
        
        async function addMotorista() {
            const nome = document.getElementById('nomeMotorista').value.trim();
            if (nome && !motoristasCadastrados.includes(nome)) {
                motoristasCadastrados.push(nome);
                
                // O AWAIT GARANTE QUE O NAVEGADOR ESPERE O FIREBASE GRAVAR
                if (await saveDataToFirestore()) { 
                    updateMotoristasList();
                    document.getElementById('nomeMotorista').value = '';
                }
            } else if (motoristasCadastrados.includes(nome)) {
                alert("Motorista j√° cadastrado.");
            }
        }
        
        async function addViagem() {
            const rota = document.getElementById('rota').value;
            if (!rota) return alert("Selecione a Rota.");
            
            const dataViagem = document.getElementById('dataViagem').value;
            if (!dataViagem) return alert("Selecione a Data da Viagem.");
            
            const trechos = [];
            
            // Trecho 1
            if (document.getElementById('motorista1').value) {
                 trechos.push({
                     motorista: document.getElementById('motorista1').value,
                     inicio: document.getElementById('inicio1').value,
                     fim: document.getElementById('fim1').value,
                     label: getTrechoLabel(rota, 1),
                     ...calculateHours(document.getElementById('inicio1').value, document.getElementById('fim1').value)
                 });
            } else { return alert("Preencha o Motorista do Trecho 1."); }
            
            // Trecho 2
            if (document.getElementById('motorista2').value) {
                trechos.push({
                    motorista: document.getElementById('motorista2').value,
                    inicio: document.getElementById('inicio2').value,
                    fim: document.getElementById('fim2').value,
                    label: getTrechoLabel(rota, 2),
                    ...calculateHours(document.getElementById('inicio2').value, document.getElementById('fim2').value)
                });
            } else { return alert("Preencha o Motorista do Trecho 2."); }

            // Trecho 3 (Se necess√°rio)
            if (rota.includes('porto')) {
                if (document.getElementById('motorista3').value) {
                    trechos.push({
                        motorista: document.getElementById('motorista3').value,
                        inicio: document.getElementById('inicio3').value,
                        fim: document.getElementById('fim3').value,
                        label: getTrechoLabel(rota, 3),
                        ...calculateHours(document.getElementById('inicio3').value, document.getElementById('fim3').value)
                    });
                } else { return alert("Preencha o Motorista do Trecho 3."); }
            }

            const novaViagem = {
                id: document.getElementById('viagemEmEdicaoId').value || `${dataViagem}_${trechos[0].inicio}`,
                data: dataViagem,
                rota: rota,
                trechos: trechos,
                timestamp: Date.now()
            };
            
            if (isEditing) {
                const index = viagensCadastradas.findIndex(v => v.id === novaViagem.id);
                if (index !== -1) {
                    viagensCadastradas[index] = novaViagem;
                } else {
                    console.error("Viagem em edi√ß√£o n√£o encontrada.");
                    return;
                }
            } else {
                if (viagensCadastradas.some(v => v.id === novaViagem.id)) {
                    alert("J√° existe uma viagem registrada com esta data e hor√°rio de in√≠cio. Use a fun√ß√£o de Edi√ß√£o.");
                    return;
                }
                viagensCadastradas.push(novaViagem);
            }

            if (await saveDataToFirestore()) {
                alert(isEditing ? "Viagem atualizada com sucesso!" : "Viagem salva com sucesso!");
                limparFormularioViagem();
            }
        }

        function editarViagem(viagemId) {
            const viagem = viagensCadastradas.find(v => v.id === viagemId);
            if (!viagem) return alert("Viagem n√£o encontrada para edi√ß√£o.");

            isEditing = true;
            document.getElementById('viagemEmEdicaoId').value = viagem.id;
            document.getElementById('mensagemEdicao').textContent = `EDITANDO VIAGEM: ${viagem.data} - ${viagem.rota}`;
            
            document.getElementById('dataViagem').value = viagem.data;
            document.getElementById('rota').value = viagem.rota;
            
            updateFormLabels(); 

            // Preenche os campos dos trechos
            // Garantir que a lista de motoristas esteja atualizada (chamado em loadData)
            viagem.trechos.forEach((trecho, index) => {
                const num = index + 1;
                const motoristaSelect = document.getElementById(`motorista${num}`);
                const inicioInput = document.getElementById(`inicio${num}`);
                const fimInput = document.getElementById(`fim${num}`);
                
                if (motoristaSelect) motoristaSelect.value = trecho.motorista;
                if (inicioInput) inicioInput.value = trecho.inicio;
                if (fimInput) fimInput.value = trecho.fim;
            });

            
            // Oculta o modal de detalhes caso estivesse aberto
            const detalhesModal = document.getElementById('detalhesModal');
            if (detalhesModal) detalhesModal.style.display = 'none';
            
            // Rola para o formul√°rio de edi√ß√£o
            document.getElementById('cadastro-viagens').scrollIntoView({ behavior: 'smooth' });
        }
        
        async function excluirViagem(viagemId) {
            if (confirm("Tem certeza que deseja EXCLUIR permanentemente esta viagem?")) {
                const index = viagensCadastradas.findIndex(v => v.id === viagemId);
                
                if (index !== -1) {
                    viagensCadastradas.splice(index, 1);
                    if (await saveDataToFirestore()) {
                        alert("Viagem exclu√≠da com sucesso.");
                        // Recarrega o relat√≥rio para refletir a exclus√£o imediatamente
                        gerarRelatorioGeralViaForm();
                    }
                } else {
                    alert("Viagem n√£o encontrada.");
                }
            }
        }
        
        async function gerarRelatorioHoras() {
            const relatoriosDiv = document.getElementById('relatorios');
            relatoriosDiv.innerHTML = ''; // Limpa relat√≥rios anteriores
            
            // 1. Coleta o M√™s/Ano do filtro
            const mesAnoInput = document.getElementById('mesAno').value;
            if (!mesAnoInput) {
                relatoriosDiv.innerHTML = '<p style="color: red; text-align: center;">Selecione o M√™s e Ano para gerar o relat√≥rio.</p>';
                return;
            }
            const [ano, mes] = mesAnoInput.split('-');

            const motoristaHours = {};
            let totalViagensFiltradas = 0;

            // 2. Filtra as viagens pelo M√™s/Ano selecionado
            const viagensFiltradas = viagensCadastradas.filter(v => {
                // A data da viagem est√° no formato YYYY-MM-DD
                return v.data.startsWith(`${ano}-${mes}`);
            });
            
            totalViagensFiltradas = viagensFiltradas.length;

            if (totalViagensFiltradas === 0) {
                 relatoriosDiv.innerHTML = `<p style="text-align: center; color: #6c757d;">N√£o h√° viagens registradas em ${formatMonthYear(mesAnoInput)}.</p>`;
                 return;
            }

            // 3. Processa cada trecho e acumula as horas por motorista
            viagensFiltradas.forEach(viagem => {
                viagem.trechos.forEach(trecho => {
                    const nomeMotorista = trecho.motorista;
                    const totalHours = parseFloat(trecho.totalHours || 0);
                    // const nightHours = parseFloat(trecho.nightHours || 0); // Implementa√ß√£o futura

                    if (!motoristaHours[nomeMotorista]) {
                        motoristaHours[nomeMotorista] = { total: 0, noturna: 0, viagens: 0 };
                    }

                    motoristaHours[nomeMotorista].total += totalHours;
                    motoristaHours[nomeMotorista].viagens += 1;
                    // motoristaHours[nomeMotorista].noturna += nightHours; // Implementa√ß√£o futura
                });
            });

            // 4. Cria a Tabela de Exibi√ß√£o
            let tableHTML = `
                <caption>Relat√≥rio de Horas Trabalhadas - ${formatMonthYear(mesAnoInput)} (${totalViagensFiltradas} Viagens)</caption>
                <table>
                    <thead>
                        <tr>
                            <th>Motorista</th>
                            <th>Total de Horas (hh:mm)</th>
                            <th>Horas Noturnas (hh:mm)</th>
                            <th>Total de Viagens</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            for (const motorista in motoristaHours) {
                const totalHours = motoristaHours[motorista].total;
                const totalViagens = motoristaHours[motorista].viagens;
                
                // Convers√£o de horas decimais para hh:mm
                const totalMinutes = Math.round(totalHours * 60);
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                const hoursFormatted = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;

                tableHTML += `
                    <tr>
                        <td>${motorista}</td>
                        <td>${hoursFormatted}</td>
                        <td class="night-hours">00:00</td> 
                        <td>${totalViagens}</td>
                    </tr>
                `;
            }

            tableHTML += `
                    </tbody>
                </table>
            `;

            relatoriosDiv.innerHTML = tableHTML;
        }


        // Substitui o placeholder e implementa a visualiza√ß√£o em cards
        async function gerarRelatorioGeralViaForm() {
            const relatoriosDiv = document.getElementById('relatorios');
            relatoriosDiv.innerHTML = ''; // Limpa relat√≥rios anteriores
            
            const mesAnoInput = document.getElementById('mesAno').value;
            let viagensFiltradas = viagensCadastradas;
            let headerText = "Todas as Viagens Cadastradas";

            if (mesAnoInput) {
                const [ano, mes] = mesAnoInput.split('-');
                viagensFiltradas = viagensCadastradas.filter(v => {
                    return v.data.startsWith(`${ano}-${mes}`);
                });
                headerText = `Viagens Registradas em ${formatMonthYear(mesAnoInput)}`;
            }

            if (viagensFiltradas.length === 0) {
                 relatoriosDiv.innerHTML = `<p style="text-align: center; color: #6c757d;">${headerText}. Nenhuma viagem encontrada.</p>`;
                 return;
            }

            // Ordena as viagens por data, da mais recente para a mais antiga
            viagensFiltradas.sort((a, b) => new Date(b.data) - new Date(a.data));

            let cardsHTML = `<h3 class="mes-header">${headerText} (${viagensFiltradas.length} Viagens)</h3>`;

            // Gera os cards
            viagensFiltradas.forEach(viagem => {
                const totalTrechos = viagem.trechos.length;
                let trechosHTML = '';
                let totalHorasViagem = 0;
                
                viagem.trechos.forEach((trecho, index) => {
                    totalHorasViagem += parseFloat(trecho.totalHours || 0);
                    
                    trechosHTML += `
                        <div class="trecho-item">
                            <p><strong>Trecho ${index + 1} (${trecho.label}):</strong></p>
                            <p>Motorista: ${trecho.motorista}</p>
                            <p>In√≠cio: ${trecho.inicio} - Fim: ${trecho.fim} (Total: ${trecho.totalHours}h)</p>
                        </div>
                    `;
                });
                
                const totalMinutes = Math.round(totalHorasViagem * 60);
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                const totalHorasFormatado = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                
                // Determinando se a viagem est√° atrasada (placeholder, mas mantendo a classe)
                const isAtrasada = false; 
                const atrasoClass = isAtrasada ? 'atrasada' : '';

                cardsHTML += `
                    <div class="viagem-card-report ${atrasoClass}">
                        <h4>Viagem: ${viagem.data} | Rota: ${viagem.rota.split('_')[0].toUpperCase()}</h4>
                        <p><strong>Total de Trechos:</strong> ${totalTrechos}</p>
                        <p><strong>Dura√ß√£o Total (Estimada/Calculada):</strong> ${totalHorasFormatado}</p>
                        ${trechosHTML}
                        <div class="action-bar" style="margin-top: 15px;">
                            <button class="btn-warning" onclick="editarViagem('${viagem.id}')">Editar</button>
                            <button class="btn-danger" onclick="excluirViagem('${viagem.id}')">Excluir</button>
                            </div>
                    </div>
                `;
            });

            relatoriosDiv.innerHTML = cardsHTML;
        }

        // Fun√ß√µes Placeholder (mantidas para o event listener n√£o quebrar)
        async function gerarRelatorioAtrasosViaForm() { alert("Fun√ß√£o Viagens Atrasadas ser√° implementada em breve."); }
        async function gerarMediaPorTrecho() { alert("Fun√ß√£o Calcular M√©dia por Trecho ser√° implementada em breve."); }
        async function exportData() { alert("Fun√ß√£o Exportar Dados ser√° implementada em breve."); }
        async function importData() { alert("Fun√ß√£o Importar Dados ser√° implementada em breve."); }
        async function clearData() { alert("Fun√ß√£o Limpar TODOS os Dados DEV ser√° implementada em breve."); }
        async function salvarJustificativa() { alert("Fun√ß√£o Salvar Justificativa ser√° implementada em breve."); }

        function setupAutoFill(sourceId, targetId) {
            document.getElementById(sourceId).addEventListener('change', (e) => {
                document.getElementById(targetId).value = e.target.value;
            });
        }

        // ----------------------------------------------------------------------
        // 6. LIGA√á√ÉO DE EVENTOS DO HTML AO ESCOPO DO M√ìDULO (CORRE√á√ÉO FINAL DE ESCOPO)
        // ----------------------------------------------------------------------
        
        function setupEventListeners() {
            // Cadastro de Motoristas
            document.getElementById('btnAddMotorista').addEventListener('click', addMotorista);

            // Cadastro de Viagens
            document.getElementById('btnSalvarViagem').addEventListener('click', addViagem);
            document.getElementById('btnLimparViagem').addEventListener('click', limparFormularioViagem);
            
            // Relat√≥rios
            document.getElementById('btnGerarRelatorioHoras').addEventListener('click', gerarRelatorioHoras);
            document.getElementById('btnGerarRelatorioGeral').addEventListener('click', gerarRelatorioGeralViaForm);
            document.getElementById('btnGerarRelatorioAtrasos').addEventListener('click', gerarRelatorioAtrasosViaForm);
            document.getElementById('btnMediaPorTrecho').addEventListener('click', gerarMediaPorTrecho);

            // Gerenciamento de Dados
            document.getElementById('btnExportData').addEventListener('click', exportData);
            document.getElementById('btnImportData').addEventListener('click', importData);
            document.getElementById('btnClearData').addEventListener('click', clearData);
            
            // Modais
            document.getElementById('btnSalvarJustificativa').addEventListener('click', salvarJustificativa);
            
            // Modal Detalhes (Fechar)
            document.getElementById('btnFecharDetalhesModal').addEventListener('click', () => {
                document.getElementById('detalhesModal').style.display = 'none';
            });
            // Modal Justificativa (Cancelar)
            document.getElementById('btnCancelarJustificativa').addEventListener('click', () => {
                document.getElementById('justificativaModal').style.display = 'none';
            });
            
            // Bot√£o EDITAR dentro do modal
            document.getElementById('btnEditarModal').addEventListener('click', () => {
                 const viagemId = document.getElementById('viagemEmEdicaoId').value;
                 if(viagemId) editarViagem(viagemId);
            });
        } 

        
        // ----------------------------------------------------------------------
        // 7. EXPOR FUN√á√ïES PARA CHAMADAS ONCLICK DO HTML GERADO
        // ----------------------------------------------------------------------
        window.editarViagem = editarViagem;
        window.excluirViagem = excluirViagem;


        // --- FUN√á√ïES DE AUTO-PREENCHIMENTO ---
        setupAutoFill('fim1', 'inicio2');
        setupAutoFill('fim2', 'inicio3');
        
        // --- INICIALIZA√á√ÉO E CHAMADAS FINAIS ---
        setupEventListeners(); 
        loadData(); // CARREGA OS DADOS SALVOS DO FIREBASE NO IN√çCIO DA P√ÅGINA
    </script>
</body>
</html>
